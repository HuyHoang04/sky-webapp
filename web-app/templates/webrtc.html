{% extends "layout.html" %}

{% block title %}WebRTC Stream - {{ device_id }}{% endblock %}

{% block head %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        height: 70vh;
        background-color: #222;
        border-radius: 5px;
        overflow: hidden;
    }
    .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .controls {
        margin-top: 10px;
    }
    .status-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 5px;
        background-color: rgba(0, 0, 0, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Stream t·ª´ {{ device_id }}</h2>
                <a href="/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i Dashboard
                </a>
            </div>
            
            <div class="card bg-dark text-light border-secondary">
                <div class="card-body">
                    <div class="video-container">
                        <video id="videoStream" autoplay playsinline></video>
                        <div class="status-indicator">
                            <span class="badge bg-warning" id="streamStatus">ƒêang k·∫øt n·ªëi...</span>
                        </div>
                    </div>
                    
                    <div class="controls d-flex justify-content-between mt-3">
                        <div>
                            <button id="startStream" class="btn btn-primary">
                                <i class="fas fa-play me-1"></i>B·∫Øt ƒë·∫ßu
                            </button>
                            <button id="stopStream" class="btn btn-danger">
                                <i class="fas fa-stop me-1"></i>D·ª´ng
                            </button>
                            <button id="captureBtn" class="btn btn-warning ms-2">
                                <i class="fas fa-camera me-1"></i>Ch·ª•p h√¨nh
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-info" id="connectionInfo">WebRTC</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detection Stats Card -->
            <div class="card bg-dark text-light border-secondary mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Th·ªëng k√™ ph√°t hi·ªán</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 border border-success rounded">
                                <i class="fas fa-male fa-2x text-success mb-2"></i>
                                <h6>Ng∆∞·ªùi tr√™n ƒë·∫•t</h6>
                                <h3 class="text-success" id="earthPersonCount">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border border-warning rounded">
                                <i class="fas fa-swimmer fa-2x text-warning mb-2"></i>
                                <h6>Ng∆∞·ªùi tr√™n bi·ªÉn</h6>
                                <h3 class="text-warning" id="seaPersonCount">0</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border border-info rounded">
                                <i class="fas fa-users fa-2x text-info mb-2"></i>
                                <h6>T·ªïng s·ªë ng∆∞·ªùi</h6>
                                <h3 class="text-info" id="totalPersonCount">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card bg-dark text-light border-secondary mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Th√¥ng tin thi·∫øt b·ªã</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>ID thi·∫øt b·ªã:</strong>
                                <span id="deviceIdDisplay">{{ device_id }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Tr·∫°ng th√°i k·∫øt n·ªëi:</strong>
                                <span id="connectionState">Ch∆∞a k·∫øt n·ªëi</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>ƒê·ªô tr·ªÖ:</strong>
                                <span id="latency">--</span>
                            </div>
                            <div class="mb-3">
                                <strong>Ch·∫•t l∆∞·ª£ng:</strong>
                                <span id="quality">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Kh·ªüi t·∫°o k·∫øt n·ªëi Socket.IO
    const socket = io();
    const deviceId = "{{ device_id }}";
    
    // C√°c ph·∫ßn t·ª≠ DOM
    const videoElement = document.getElementById('videoStream');
    const startStreamButton = document.getElementById('startStream');
    const stopStreamButton = document.getElementById('stopStream');
    const streamStatus = document.getElementById('streamStatus');
    const connectionState = document.getElementById('connectionState');
    const latencyDisplay = document.getElementById('latency');
    
    let peerConnection;
    let startTime;
    
    // Kh·ªüi t·∫°o k·∫øt n·ªëi WebRTC
    async function startWebRTC() {
        try {
            streamStatus.textContent = 'ƒêang k·∫øt n·ªëi...';
            streamStatus.className = 'badge bg-warning';
            connectionState.textContent = 'ƒêang thi·∫øt l·∫≠p k·∫øt n·ªëi';
            
            // Ghi l·∫°i th·ªùi gian b·∫Øt ƒë·∫ßu ƒë·ªÉ t√≠nh ƒë·ªô tr·ªÖ
            startTime = Date.now();
            
            // T·∫°o peer connection
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // X·ª≠ l√Ω khi tr·∫°ng th√°i k·∫øt n·ªëi thay ƒë·ªïi
            peerConnection.onconnectionstatechange = () => {
                connectionState.textContent = peerConnection.connectionState;
                
                if (peerConnection.connectionState === 'connected') {
                    // T√≠nh ƒë·ªô tr·ªÖ
                    const latency = Date.now() - startTime;
                    latencyDisplay.textContent = `${latency}ms`;
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    streamStatus.textContent = 'ƒêang ph√°t';
                    streamStatus.className = 'badge bg-success';
                } else if (peerConnection.connectionState === 'failed' || 
                           peerConnection.connectionState === 'disconnected' ||
                           peerConnection.connectionState === 'closed') {
                    streamStatus.textContent = 'Ng·∫Øt k·∫øt n·ªëi';
                    streamStatus.className = 'badge bg-danger';
                }
            };
            
            // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c ICE candidate
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('webrtc_ice_candidate', {
                        device_id: deviceId,
                        candidate: event.candidate
                    });
                }
            };
            
            // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c track
            peerConnection.ontrack = event => {
                videoElement.srcObject = event.streams[0];
                
                // ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng video
                const videoTrack = event.streams[0].getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    document.getElementById('quality').textContent = 
                        `${settings.width}x${settings.height} @ ${settings.frameRate || '--'}fps`;
                }
            };
            
            // T·∫°o offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // G·ª≠i offer ƒë·∫øn server
            socket.emit('webrtc_offer', {
                device_id: deviceId,
                sdp: peerConnection.localDescription.sdp,
                type: peerConnection.localDescription.type
            });
        } catch (error) {
            console.error('L·ªói khi kh·ªüi t·∫°o WebRTC:', error);
            streamStatus.textContent = 'L·ªói k·∫øt n·ªëi';
            streamStatus.className = 'badge bg-danger';
            connectionState.textContent = 'L·ªói: ' + error.message;
        }
    }
    
    // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c answer t·ª´ server
    socket.on('webrtc_answer', async function(data) {
        if (!peerConnection || data.device_id !== deviceId) return;
        
        try {
            const remoteDesc = new RTCSessionDescription({
                sdp: data.sdp,
                type: data.type
            });
            
            await peerConnection.setRemoteDescription(remoteDesc);
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω answer:', error);
        }
    });
    
    // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c ICE candidate t·ª´ server
    socket.on('webrtc_ice_candidate', async function(data) {
        if (!peerConnection || data.device_id !== deviceId) return;
        
        try {
            await peerConnection.addIceCandidate(data.candidate);
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω ICE candidate:', error);
        }
    });
    
    // S·ª± ki·ªán khi nh·∫•n n√∫t b·∫Øt ƒë·∫ßu stream
    startStreamButton.addEventListener('click', function() {
        startWebRTC();
    });
    
    // S·ª± ki·ªán khi nh·∫•n n√∫t d·ª´ng stream
    stopStreamButton.addEventListener('click', function() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        videoElement.srcObject = null;
        streamStatus.textContent = 'ƒê√£ d·ª´ng';
        streamStatus.className = 'badge bg-secondary';
        connectionState.textContent = 'Ng·∫Øt k·∫øt n·ªëi';
        latencyDisplay.textContent = '--';
        document.getElementById('quality').textContent = '--';
    });
    
    // S·ª± ki·ªán khi nh·∫•n n√∫t ch·ª•p h√¨nh
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.addEventListener('click', function() {
        console.log('üì∏ G·ª≠i y√™u c·∫ßu ch·ª•p h√¨nh...');
        
        // Disable button while processing
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang ch·ª•p...';
        
        // Emit capture request via Socket.IO
        socket.emit('capture_request', {
            device_id: deviceId,
            timestamp: new Date().toISOString()
        });
        
        // Re-enable button after 3 seconds
        setTimeout(() => {
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i>Ch·ª•p h√¨nh';
        }, 3000);
    });
    
    // Listen for capture success
    socket.on('capture_success', function(data) {
        if (data.device_id === deviceId) {
            console.log('‚úÖ Ch·ª•p h√¨nh th√†nh c√¥ng:', data);
            
            // Show success notification
            alert(`‚úÖ Ch·ª•p h√¨nh th√†nh c√¥ng!\n\nCapture ID: ${data.capture_id}\nGPS: ${data.gps_data?.latitude}, ${data.gps_data?.longitude}\nƒêang ph√¢n t√≠ch AI...`);
            
            // Optional: Open image in new tab
            // window.open(data.image_url, '_blank');
        }
    });
    
    // Listen for capture error
    socket.on('capture_error', function(data) {
        console.error('‚ùå L·ªói ch·ª•p h√¨nh:', data);
        alert('‚ùå L·ªói ch·ª•p h√¨nh: ' + data.error);
        
        // Re-enable button
        captureBtn.disabled = false;
        captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i>Ch·ª•p h√¨nh';
    });
    
    // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu stream khi trang ƒë∆∞·ª£c t·∫£i
    window.addEventListener('load', function() {
        startWebRTC();
    });
    
    // Listen for detection updates via Socket.IO
    socket.on('detection_update', function(data) {
        if (data.device_id === deviceId) {
            // Update person counts
            document.getElementById('earthPersonCount').textContent = data.earth_person_count || 0;
            document.getElementById('seaPersonCount').textContent = data.sea_person_count || 0;
            document.getElementById('totalPersonCount').textContent = data.person_count || 0;
        }
    });
</script>
{% endblock %}