{% extends "layout.html" %}
{% block title %}Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
    /* Reset */
    * {
        box-sizing: border-box;
    }
    
    body {
        overflow-y: auto; /* CHO PHÉP SCROLL TOÀN TRANG */
        overflow-x: hidden;
    }
    
    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }
    
    /* Main Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 0.8fr 1fr; /* Video | Checklist+Voice | GPS */
        grid-template-rows: auto auto auto; /* Row 1: Main | Row 2: Action buttons | Row 3: Bottom grid */
        gap: 10px;
        padding: 10px;
        min-height: calc(100vh - 72px); /* MIN-HEIGHT thay vì HEIGHT để cho phép scroll */
    }
    
    /* ============ ROW 1: VIDEO + CHECKLIST/VOICE + GPS ============ */
    
    /* Video - Cột 1, Row 1 */
    .video-section {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        height: 600px; /* FIXED HEIGHT cho video */
    }
    
    /* Cột giữa - Mission Control Table + Voice Records */
    .middle-column {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 600px; /* FIXED HEIGHT */
    }
    
    /* Mission Control Table - 50% - THÊM SCROLL */
    .mission-control-section {
        flex: 1;
        background: rgba(30,30,30,0.9);
        border-radius: 12px;
        padding: 15px;
        overflow-y: auto; /* ✅ SCROLL CHO MISSION TABLE */
        max-height: 295px; /* Giới hạn chiều cao */
    }
    
    /* Voice Records - 50% - THÊM SCROLL */
    .voice-section {
        flex: 1;
        background: rgba(30,30,30,0.9);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        max-height: 295px; /* Giới hạn chiều cao */
    }
    
    /* GPS - Cột 3, bên phải ngoài cùng */
    .gps-section {
        grid-column: 3 / 4;
        grid-row: 1 / 2;
        background: rgba(30,30,30,0.9);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        height: 600px; /* FIXED HEIGHT */
    }
    
    /* ============ ROW 2: ACTION BUTTONS ============ */
    
    .action-buttons-row {
        grid-column: 1 / 4; /* Full width */
        grid-row: 2 / 3;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        height: 80px;
    }
    
    .action-button {
        background: rgba(30,30,30,0.9);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        color: white;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 500;
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .action-button i {
        font-size: 24px;
    }
    
    .action-button.add-mission {
        border-color: #52c41a;
    }

    .action-button.add-mission:hover {
        background: rgba(82,196,26,0.2);
        border-color: #52c41a;
    }
    
    .action-button.drop-items {
        border-color: #faad14;
    }
    
    .action-button.drop-items:hover {
        background: rgba(250,173,20,0.2);
        border-color: #faad14;
    }
    
    .action-button.record-voice {
        border-color: #ff4d4f;
    }
    
    .action-button.record-voice:hover {
        background: rgba(255,77,79,0.2);
        border-color: #ff4d4f;
    }
    
    .action-button.record-voice.recording {
        background: rgba(255,77,79,0.3);
        animation: pulse-red 1.5s infinite;
    }
    
    @keyframes pulse-red {
        0%, 100% {
            border-color: #ff4d4f;
        }
        50% {
            border-color: #ff0000;
        }
    }
    
    .action-button.device {
        border-color: #52c41a;
    }
    
    .action-button.device:hover {
        background: rgba(82,196,26,0.2);
        border-color: #52c41a;
    }
    
    /* ============ ROW 3: BOTTOM GRID ============ */
    
    .bottom-grid {
        grid-column: 1 / 4; /* Full width */
        grid-row: 3 / 4;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        height: 250px; /* TĂNG CHIỀU CAO để chứa nội dung scroll */
    }
    
    /* ============ VIDEO SECTION ============ */
    .video-grid {
        width: 100%;
        height: 100%;
        position: relative;
    }
    
    .video-grid video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000;
    }
    
    .video-overlay {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 10;
    }
    
    .drone-selector {
        background: rgba(0,0,0,0.8);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
    }
    
    .drone-selector:focus {
        outline: none;
        border-color: #00c2ff;
    }
    
    .video-controls-bottom {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 10;
    }
    
    .control-btn {
        background: rgba(0,0,0,0.8);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.2);
        border-color: white;
        transform: scale(1.1);
    }
    
    .control-btn.play {
        background: white;
        color: black;
    }
    
    .control-btn.record {
        background: #ff0000;
        border-color: #ff0000;
    }
    
    .video-info-overlay {
        position: absolute;
        bottom: 70px;
        left: 15px;
        right: 15px;
        display: flex;
        justify-content: space-between;
        color: white;
        font-size: 11px;
        z-index: 10;
        gap: 10px;
    }
    
    .info-item {
        background: rgba(0,0,0,0.7);
        padding: 6px 12px;
        border-radius: 6px;
        white-space: nowrap;
    }
    
    /* ============ COMMON STYLES ============ */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-shrink: 0; /* Không co lại khi scroll */
    }
    
    .section-header h6 {
        font-size: 14px;
        margin: 0;
        color: white;
        font-weight: 600;
    }
    
    .add-item-btn {
        background: rgba(0,194,255,0.2);
        border: 1px solid #00c2ff;
        color: #00c2ff;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.3s;
    }
    
    .add-item-btn:hover {
        background: rgba(0,194,255,0.3);
    }
    
    /* ============ MISSION CONTROL TABLE - SCROLL ============ */
    .mission-table-wrapper {
        overflow-y: auto; /* ✅ SCROLL */
        flex: 1;
        padding-right: 5px; /* Space for scrollbar */
    }
    
    .mission-item {
        background: rgba(0,0,0,0.4);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        border-left: 3px solid transparent;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .mission-item:hover {
        background: rgba(0,0,0,0.6);
        border-left-color: #00c2ff;
    }
    
    .mission-item.active {
        border-left-color: #52c41a;
        background: rgba(82, 196, 26, 0.1);
    }
    
    .mission-item.planned {
        border-left-color: #faad14;
    }
    
    .mission-item.completed {
        border-left-color: #8c8c8c;
        opacity: 0.7;
    }
    
    .mission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    
    .mission-name {
        font-size: 12px;
        font-weight: 600;
        color: white;
    }
    
    .mission-status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 12px;
    }
    
    .mission-details {
        font-size: 10px;
        color: rgba(255,255,255,0.7);
        display: flex;
        gap: 10px;
        margin-top: 4px;
    }
    
    .mission-actions {
        margin-top: 8px;
        display: flex;
        gap: 4px;
    }
    
    .mission-actions button {
        font-size: 10px;
        padding: 3px 8px;
    }
    
    /* ============ WAYPOINTS SECTION ============ */
    .waypoint-item {
        background: rgba(0,0,0,0.4);
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
    }
    
    .waypoint-item:hover {
        background: rgba(0,0,0,0.6);
    }
    
    .waypoint-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }
    
    .waypoint-number {
        background: #1890ff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .waypoint-coords {
        font-size: 10px;
        color: rgba(255,255,255,0.8);
    }
    
    .waypoint-actions {
        display: flex;
        gap: 4px;
    }
    
    .waypoint-actions button {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 3px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.3s;
    }
    
    .waypoint-actions button:hover {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.5);
    }
    
    .waypoint-actions button.delete:hover {
        background: rgba(255,77,79,0.2);
        border-color: #ff4d4f;
        color: #ff4d4f;
    }
    
    /* ============ CHECKLIST SECTION - SCROLL ============ */
    .checklist-items-wrapper {
        overflow-y: auto; /* ✅ SCROLL */
        flex: 1;
        padding-right: 5px; /* Space for scrollbar */
    }
    
    .checklist-item {
        background: rgba(0,0,0,0.4);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
    }
    
    .checklist-item:hover {
        background: rgba(0,0,0,0.6);
    }
    
    .checklist-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #00c2ff;
        flex-shrink: 0;
    }
    
    .checklist-item label {
        font-size: 13px;
        margin: 0;
        color: white;
        cursor: pointer;
        flex: 1;
    }
    
    /* ============ VOICE RECORDS SECTION - SCROLL ============ */
    .voice-items-wrapper {
        flex: 1;
        overflow-y: auto; /* ✅ SCROLL */
        padding-right: 5px; /* Space for scrollbar */
    }
    
    .voice-item {
        background: rgba(0,0,0,0.4);
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .voice-item:hover {
        background: rgba(0,0,0,0.6);
    }
    
    .voice-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .voice-info .voice-name {
        color: white;
        font-size: 12px;
        font-weight: 500;
    }
    
    .voice-time {
        color: rgba(255,255,255,0.6);
        font-size: 10px;
    }
    
    .download-btn {
        background: #007bff;
        border: none;
        padding: 5px 10px;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.3s;
        width: 100%;
    }
    
    .download-btn:hover {
        background: #0056b3;
    }
    
    /* ============ GPS SECTION ============ */
    #map {
        flex: 1;
        border-radius: 8px;
        min-height: 0;
    }
    
    .gps-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-top: 10px;
        flex-shrink: 0; /* Không co lại */
    }
    
    .gps-stat {
        text-align: center;
        padding: 6px 4px;
        background: rgba(0,0,0,0.3);
        border-radius: 6px;
    }
    
    .gps-stat-label {
        color: rgba(255,255,255,0.6);
        font-size: 9px;
        display: block;
    }
    
    .gps-stat-value {
        color: white;
        font-weight: bold;
        font-size: 12px;
        display: block;
        margin-top: 2px;
    }
    
    /* ============ BOTTOM GRID ITEMS ============ */
    .grid-item {
        background: rgba(30,30,30,0.9);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Giữ cho các item con có thể scroll */
    }
    
    .grid-item h6 {
        font-size: 13px;
        margin: 0 0 10px 0;
        color: white;
        font-weight: 600;
        flex-shrink: 0; /* Không co lại khi scroll */
    }
    
    .chart-wrapper {
        flex: 1;
        position: relative;
        min-height: 0;
    }
    
    #detectionChart,
    #heatmap {
        width: 100% !important;
        height: 100% !important;
    }
    
    /* Task List - SCROLL */
    .task-list {
        flex: 1;
        overflow-y: auto; /* ✅ SCROLL CHO ONGOING TASK */
        padding-right: 5px; /* Space for scrollbar */
    }
    
    .task-item {
        background: rgba(0,0,0,0.4);
        padding: 8px;
        border-radius: 8px;
        margin-bottom: 6px;
    }
    
    .task-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    
    .task-title {
        font-weight: 600;
        color: white;
        font-size: 11px;
    }
    
    .task-time {
        color: rgba(255,255,255,0.6);
        font-size: 10px;
    }
    
    .task-progress {
        background: rgba(255,255,255,0.1);
        height: 4px;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .task-progress-bar {
        background: linear-gradient(90deg, #00c2ff, #0080ff);
        height: 100%;
        transition: width 0.3s;
    }
    
    /* Event Logs - SCROLL */
    .event-logs-wrapper {
        flex: 1;
        overflow-y: auto; /* ✅ SCROLL CHO EVENT LOGS */
        padding-right: 5px; /* Space for scrollbar */
    }
    
    .event-item {
        padding: 6px 8px;
        border-left: 3px solid transparent;
        margin-bottom: 5px;
        border-radius: 4px;
        background: rgba(0,0,0,0.3);
        font-size: 10px;
    }
    
    .event-item.warning {
        border-left-color: #faad14;
        background: rgba(250, 173, 20, 0.1);
    }
    
    .event-item.error {
        border-left-color: #ff4d4f;
        background: rgba(255, 77, 79, 0.1);
    }
    
    .event-item.success {
        border-left-color: #52c41a;
        background: rgba(82, 196, 26, 0.1);
    }
    
    .event-item.info {
        border-left-color: #1890ff;
        background: rgba(24, 144, 255, 0.1);
    }
    
    .event-time {
        color: rgba(255,255,255,0.5);
        font-size: 9px;
        margin-right: 6px;
    }
    
    .event-message {
        color: white;
    }
    
    /* ============ SCROLLBAR STYLING ============ */
    
    /* Custom scrollbar cho tất cả scrollable elements */
    .checklist-items-wrapper::-webkit-scrollbar,
    .voice-items-wrapper::-webkit-scrollbar,
    .task-list::-webkit-scrollbar,
    .event-logs-wrapper::-webkit-scrollbar,
    .checklist-section::-webkit-scrollbar,
    body::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .checklist-items-wrapper::-webkit-scrollbar-track,
    .voice-items-wrapper::-webkit-scrollbar-track,
    .task-list::-webkit-scrollbar-track,
    .event-logs-wrapper::-webkit-scrollbar-track,
    .checklist-section::-webkit-scrollbar-track,
    body::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
    
    .checklist-items-wrapper::-webkit-scrollbar-thumb,
    .voice-items-wrapper::-webkit-scrollbar-thumb,
    .task-list::-webkit-scrollbar-thumb,
    .event-logs-wrapper::-webkit-scrollbar-thumb,
    .checklist-section::-webkit-scrollbar-thumb,
    body::-webkit-scrollbar-thumb {
        background: rgba(0,194,255,0.5);
        border-radius: 4px;
    }
    
    .checklist-items-wrapper::-webkit-scrollbar-thumb:hover,
    .voice-items-wrapper::-webkit-scrollbar-thumb:hover,
    .task-list::-webkit-scrollbar-thumb:hover,
    .event-logs-wrapper::-webkit-scrollbar-thumb:hover,
    .checklist-section::-webkit-scrollbar-thumb:hover,
    body::-webkit-scrollbar-thumb:hover {
        background: rgba(0,194,255,0.7);
    }
    
    /* Responsive */
    @media (max-width: 1400px) {
        .dashboard-grid {
            grid-template-columns: 1.5fr 0.8fr 1fr;
        }
    }
    
    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto auto;
            min-height: auto;
        }
        
        .video-section {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            height: 400px;
        }
        
        .middle-column {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
            height: auto;
        }
        
        .checklist-section,
        .voice-section {
            max-height: 300px;
        }
        
        .gps-section {
            grid-column: 1 / 2;
            grid-row: 3 / 4;
            height: 400px;
        }
        
        .action-buttons-row {
            grid-column: 1 / 2;
            grid-row: 4 / 5;
            grid-template-columns: repeat(2, 1fr);
            height: auto;
        }
        
        .bottom-grid {
            grid-column: 1 / 2;
            grid-row: 5 / 6;
            grid-template-columns: 1fr 1fr;
            height: auto;
        }
    }
    
    @media (max-width: 768px) {
        .action-buttons-row,
        .bottom-grid {
            grid-template-columns: 1fr;
        }
        
        .action-button {
            height: 70px;
        }
    }
    /* ============ MODAL STYLES ============ */
    .modal-content {
        background: rgba(20, 20, 20, 0.98);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        backdrop-filter: blur(20px);
    }

    .modal-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 1.5rem;
    }

    .modal-header .modal-title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .modal-body {
        padding: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
    }

    .modal-footer {
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 1rem 1.5rem;
    }

    .modal-body .form-label {
        color: rgba(255,255,255,0.9);
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .modal-body .form-control,
    .modal-body .form-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        border-radius: 8px;
        padding: 0.6rem 0.75rem;
    }

    .modal-body .form-control:focus,
    .modal-body .form-select:focus {
        background: rgba(255,255,255,0.15);
        border-color: #00c2ff;
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(0,194,255,0.25);
    }

    .modal-body .form-control::placeholder {
        color: rgba(255,255,255,0.5);
    }

    .modal-body .form-select option {
        background: #1a1a1a;
        color: white;
    }

    .modal-body .btn-outline-info {
        border-color: #00c2ff;
        color: #00c2ff;
    }

    .modal-body .btn-outline-info:hover {
        background: rgba(0,194,255,0.2);
        border-color: #00c2ff;
        color: white;
    }

    .modal-body .btn-outline-secondary {
        border-color: rgba(255,255,255,0.3);
        color: rgba(255,255,255,0.9);
    }

    .modal-body .btn-outline-secondary:hover {
        background: rgba(255,255,255,0.1);
        border-color: rgba(255,255,255,0.5);
        color: white;
    }

    .waypoint-item {
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .waypoint-item input {
        flex: 1;
    }

    .waypoint-item .btn-sm {
        padding: 0.25rem 0.5rem;
    }

    /* Modal scrollbar */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: rgba(0,194,255,0.5);
        border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
        background: rgba(0,194,255,0.7);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="dashboard-grid">
        <!-- ============ ROW 1: VIDEO + CHECKLIST/VOICE + GPS ============ -->
        
        <!-- Video Section - Cột 1 -->
        <div class="video-section">
            <div class="video-overlay">
                <select class="drone-selector" id="droneSelector">
                    <option value="drone-camera">Drone Camera</option>
                    <option value="drone1">Drone 1</option>
                    <option value="drone2">Drone 2</option>
                </select>
            </div>
            
            <div class="video-grid" id="videoGrid">
                <!-- Video will be added here by VideoLayoutManager -->
            </div>
            
            <div class="video-info-overlay">
                <div class="info-item">
                    <strong>Active Drone:</strong> <span id="activeDrone">Drone Camera</span>
                </div>
                <div class="info-item">
                    <strong>Longitude:</strong> <span id="videoLongitude">105.8542</span>
                </div>
                <div class="info-item">
                    <strong>Latitude:</strong> <span id="videoLatitude">21.0285</span>
                </div>
            </div>
            
            <div class="video-controls-bottom">
                <button class="control-btn play" id="playBtn" title="Start Stream">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="stopBtn" title="Stop Stream">
                    <i class="fas fa-stop"></i>
                </button>
                <button class="control-btn record" id="recordBtn" title="Capture">
                    <i class="fas fa-camera"></i>
                </button>
                <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn" id="layoutBtn" title="Toggle Layout">
                    <i class="fas fa-th"></i>
                </button>
            </div>
        </div>
        
        <!-- Middle Column - Cột 2 (Checklist + Voice) -->
        <div class="middle-column">
            <!-- Item Checklist - 50% - CÓ SCROLL -->
            <!-- Mission Control Table - 50% - CÓ SCROLL -->
            <div class="mission-control-section">
                <div class="section-header">
                    <h6>Mission Control</h6>
                    <span class="badge bg-info" id="missionCount">0 Missions</span>
                </div>
                <div class="mission-table-wrapper" id="missionControlTable">
                    <p class="text-muted text-center" style="margin: 20px 0; font-size: 11px;">No missions created yet</p>
                </div>
            </div>
            
            <!-- Voice Records - 50% - CÓ SCROLL -->
            <div class="voice-section">
                <div class="section-header">
                    <h6>Voice Records</h6>
                    <select class="drone-selector" style="width: auto; padding: 4px 8px; font-size: 11px;">
                        <option>Drone 1</option>
                        <option>Drone 2</option>
                    </select>
                </div>
                <div class="voice-items-wrapper" id="voiceRecords">
                    <div class="voice-item">
                        <div class="voice-info">
                            <span class="voice-name">remote_mile_01</span>
                            <span class="voice-time">23:27:17 18/11/2025</span>
                        </div>
                        <button class="download-btn"><i class="fas fa-download"></i> Download</button>
                    </div>
                    <div class="voice-item">
                        <div class="voice-info">
                            <span class="voice-name">remote_mile_02</span>
                            <span class="voice-time">23:27:17 18/11/2025</span>
                        </div>
                        <button class="download-btn"><i class="fas fa-download"></i> Download</button>
                    </div>
                    <div class="voice-item">
                        <div class="voice-info">
                            <span class="voice-name">remote_mile_03</span>
                            <span class="voice-time">22:15:30 18/11/2025</span>
                        </div>
                        <button class="download-btn"><i class="fas fa-download"></i> Download</button>
                    </div>
                    <div class="voice-item">
                        <div class="voice-info">
                            <span class="voice-name">remote_mile_04</span>
                            <span class="voice-time">21:45:12 18/11/2025</span>
                        </div>
                        <button class="download-btn"><i class="fas fa-download"></i> Download</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GPS Section - Cột 3 (Bên phải ngoài cùng) -->
        <div class="gps-section">
            <div class="section-header" style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <h6 style="margin: 0; color: white; font-size: 14px; font-weight: 600;">GPS Tracking</h6>
                <button class="btn btn-sm btn-outline-info" id="addWaypointBtn" title="Add Waypoint">
                    <i class="fas fa-map-marker-plus"></i>
                </button>
            </div>
            <div id="map"></div>
            
            <!-- Waypoints List -->
            <div class="waypoints-section" style="margin-top: 10px; max-height: 120px; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 600;">Waypoints</span>
                    <button class="btn btn-sm btn-outline-success" id="optimizeRouteBtn" style="font-size: 10px; padding: 2px 8px;" title="Optimize Route">
                        <i class="fas fa-route"></i> Auto Route
                    </button>
                </div>
                <div id="waypointsList" style="font-size: 11px;">
                    <p class="text-muted text-center" style="margin: 10px 0; font-size: 10px;">Click map or Add button</p>
                </div>
            </div>
            
            <!-- Detection Stats -->
            <div class="gps-stats" style="margin-top: 10px;">
                <div class="gps-stat">
                    <span class="gps-stat-label">Earth People</span>
                    <span class="gps-stat-value" id="statEarth">0</span>
                </div>
                <div class="gps-stat">
                    <span class="gps-stat-label">Total</span>
                    <span class="gps-stat-value" id="statTotal">0</span>
                </div>
                <div class="gps-stat">
                    <span class="gps-stat-label">Sea People</span>
                    <span class="gps-stat-value" id="statSea">0</span>
                </div>
            </div>
        </div>
        
        <!-- ============ ROW 2: ACTION BUTTONS ============ -->
        <div class="action-buttons-row">
            <button class="action-button add-mission" id="addMissionBtn" data-bs-toggle="modal" data-bs-target="#newMissionModal">
                <i class="fas fa-plus-circle"></i>
                <span>Add Mission</span>
            </button>
            <button class="action-button drop-items" id="dropItemsBtn">
                <i class="fas fa-parachute-box"></i>
                <span>Drop Items</span>
            </button>
            <button class="action-button record-voice" id="recordVoiceBtn">
                <i class="fas fa-microphone"></i>
                <span>Record Voice</span>
            </button>
            <button class="action-button device" id="deviceBtn">
                <i class="fas fa-mobile-alt"></i>
                <span>Device</span>
            </button>
        </div>
        
        <!-- ============ ROW 3: BOTTOM GRID ============ -->
        <div class="bottom-grid">
            <!-- Detection Chart -->
            <div class="grid-item">
                <h6>Detection People Analysis Chart</h6>
                <div class="chart-wrapper">
                    <canvas id="detectionChart"></canvas>
                </div>
            </div>
            
            <!-- Heatmap -->
            <div class="grid-item">
                <h6>Heatmap</h6>
                <div class="chart-wrapper">
                    <div id="heatmap" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            
            <!-- Ongoing Task - CÓ SCROLL -->
            <div class="grid-item">
                <div class="section-header" style="margin-bottom: 10px;">
                    <h6 style="margin: 0;">Ongoing Task</h6>
                    <select class="drone-selector" style="width: auto; padding: 3px 6px; font-size: 10px;">
                        <option>Drone 1</option>
                    </select>
                </div>
                <div class="task-list" id="taskList">
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-title">Example - 3 days testing</span>
                            <span class="task-time">23:54:00</span>
                        </div>
                        <div class="task-progress">
                            <div class="task-progress-bar" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-title">Search Mission Alpha</span>
                            <span class="task-time">12:30:00</span>
                        </div>
                        <div class="task-progress">
                            <div class="task-progress-bar" style="width: 45%"></div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-title">Rescue Operation Bravo</span>
                            <span class="task-time">08:15:22</span>
                        </div>
                        <div class="task-progress">
                            <div class="task-progress-bar" style="width: 80%"></div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-title">Survey Delta Zone</span>
                            <span class="task-time">06:45:10</span>
                        </div>
                        <div class="task-progress">
                            <div class="task-progress-bar" style="width: 30%"></div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-title">Patrol Route Echo</span>
                            <span class="task-time">03:20:55</span>
                        </div>
                        <div class="task-progress">
                            <div class="task-progress-bar" style="width: 55%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Event Logs - CÓ SCROLL -->
            <div class="grid-item">
                <h6>Event Logs</h6>
                <div class="event-logs-wrapper" id="eventLogs">
                    <div class="event-item success">
                        <span class="event-time">[12:00]</span>
                        <span class="event-message">AI: Person detected (CpuO) at 10.7826,106.6001</span>
                    </div>
                    <div class="event-item warning">
                        <span class="event-time">[12:05]</span>
                        <span class="event-message">Warning: Battery 25%</span>
                    </div>
                    <div class="event-item info">
                        <span class="event-time">[12:10]</span>
                        <span class="event-message">Command: Return Home</span>
                    </div>
                    <div class="event-item success">
                        <span class="event-time">[14:27]</span>
                        <span class="event-message">Video: Playback Received</span>
                    </div>
                    <div class="event-item info">
                        <span class="event-time">[15:30]</span>
                        <span class="event-message">GPS coordinates saved</span>
                    </div>
                    <div class="event-item warning">
                        <span class="event-time">[16:12]</span>
                        <span class="event-message">Signal strength: Weak</span>
                    </div>
                    <div class="event-item success">
                        <span class="event-time">[17:05]</span>
                        <span class="event-message">Mission completed successfully</span>
                    </div>
                    <div class="event-item error">
                        <span class="event-time">[18:20]</span>
                        <span class="event-message">Error: Camera connection lost</span>
                    </div>
                    <div class="event-item info">
                        <span class="event-time">[19:45]</span>
                        <span class="event-message">System health check: OK</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ============ NEW MISSION MODAL ============ -->
    <div class="modal fade" id="newMissionModal" tabindex="-1" aria-labelledby="newMissionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newMissionModalLabel">
                        <i class="fas fa-plus-circle me-2"></i>Create New Mission
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newMissionForm">
                        <!-- Mission Name -->
                        <div class="mb-3">
                            <label for="missionName" class="form-label">
                                <i class="fas fa-tag me-2"></i>Mission Name
                            </label>
                            <input type="text" class="form-control" id="missionName" placeholder="Enter mission name" required>
                        </div>
                        
                        <!-- Mission Type -->
                        <div class="mb-3">
                            <label for="missionType" class="form-label">
                                <i class="fas fa-tasks me-2"></i>Mission Type
                            </label>
                            <select class="form-select" id="missionType" required>
                                <option value="">Select mission type</option>
                                <option value="search">Search & Rescue</option>
                                <option value="survey">Survey</option>
                                <option value="patrol">Patrol</option>
                                <option value="delivery">Delivery</option>
                                <option value="inspection">Inspection</option>
                                <option value="mapping">Mapping</option>
                            </select>
                        </div>
                        
                        <!-- Drone Assignment -->
                        <div class="mb-3">
                            <label for="assignedDrone" class="form-label">
                                <i class="fas fa-drone me-2"></i>Assigned Drone
                            </label>
                            <select class="form-select" id="assignedDrone" required>
                                <option value="">Select drone</option>
                                <option value="drone1">Drone 1</option>
                                <option value="drone2">Drone 2</option>
                                <option value="drone3">Drone 3</option>
                            </select>
                        </div>
                        
                        <!-- Location -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="missionLatitude" class="form-label">
                                    <i class="fas fa-map-marker-alt me-2"></i>Latitude
                                </label>
                                <input type="number" step="0.000001" class="form-control" id="missionLatitude" placeholder="52.520000" required>
                            </div>
                            <div class="col-md-6">
                                <label for="missionLongitude" class="form-label">
                                    <i class="fas fa-map-marker-alt me-2"></i>Longitude
                                </label>
                                <input type="number" step="0.000001" class="form-control" id="missionLongitude" placeholder="13.405000" required>
                            </div>
                        </div>
                        
                        <!-- Auto-fill current location button -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-info" id="useCurrentLocation">
                                <i class="fas fa-crosshairs me-2"></i>Use Current Drone Location
                            </button>
                        </div>
                        
                        <!-- Altitude & Speed -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="missionAltitude" class="form-label">
                                    <i class="fas fa-arrows-alt-v me-2"></i>Altitude (m)
                                </label>
                                <input type="number" class="form-control" id="missionAltitude" placeholder="50" min="10" max="500" required>
                            </div>
                            <div class="col-md-6">
                                <label for="missionSpeed" class="form-label">
                                    <i class="fas fa-tachometer-alt me-2"></i>Speed (km/h)
                                </label>
                                <input type="number" class="form-control" id="missionSpeed" placeholder="20" min="5" max="80" required>
                            </div>
                        </div>
                        
                        <!-- Scheduled Time -->
                        <div class="mb-3">
                            <label for="scheduledTime" class="form-label">
                                <i class="fas fa-clock me-2"></i>Scheduled Start Time
                            </label>
                            <input type="datetime-local" class="form-control" id="scheduledTime" required>
                        </div>
                        
                        <!-- Duration -->
                        <div class="mb-3">
                            <label for="missionDuration" class="form-label">
                                <i class="fas fa-hourglass-half me-2"></i>Estimated Duration (minutes)
                            </label>
                            <input type="number" class="form-control" id="missionDuration" placeholder="30" min="1" required>
                        </div>
                        
                        <!-- Priority -->
                        <div class="mb-3">
                            <label for="missionPriority" class="form-label">
                                <i class="fas fa-exclamation-circle me-2"></i>Priority
                            </label>
                            <select class="form-select" id="missionPriority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-3">
                            <label for="missionDescription" class="form-label">
                                <i class="fas fa-align-left me-2"></i>Description
                            </label>
                            <textarea class="form-control" id="missionDescription" rows="3" placeholder="Enter mission details and objectives..."></textarea>
                        </div>
                        
                        <!-- Waypoints -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-route me-2"></i>Waypoints
                            </label>
                            <div id="missionWaypointsList" class="mb-2">
                                <!-- Waypoints will be added here dynamically -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="addMissionWaypointBtn">
                                <i class="fas fa-plus me-2"></i>Add Waypoint
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="createMissionBtn">
                        <i class="fas fa-check me-2"></i>Create Mission
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ ADD WAYPOINT MODAL ============ -->
    <div class="modal fade" id="addWaypointModal" tabindex="-1" aria-labelledby="addWaypointModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWaypointModalLabel">
                        <i class="fas fa-map-marker-plus me-2"></i>Add Waypoint
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addWaypointForm">
                        <div class="mb-3">
                            <label for="waypointLat" class="form-label">Latitude</label>
                            <input type="number" step="0.000001" class="form-control" id="waypointLat" placeholder="21.028500" required>
                        </div>
                        <div class="mb-3">
                            <label for="waypointLng" class="form-label">Longitude</label>
                            <input type="number" step="0.000001" class="form-control" id="waypointLng" placeholder="105.854200" required>
                        </div>
                        <div class="mb-3">
                            <label for="waypointAlt" class="form-label">Altitude (m)</label>
                            <input type="number" class="form-control" id="waypointAlt" placeholder="50" value="50">
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-info" id="useMapCenterBtn">
                                <i class="fas fa-map me-2"></i>Use Map Center
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" id="useCurrentPosBtn">
                                <i class="fas fa-crosshairs me-2"></i>Use Current Position
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAddWaypoint">Add Waypoint</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ DEVICE LIST MODAL ============ -->
    <div class="modal fade" id="deviceListModal" tabindex="-1" aria-labelledby="deviceListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceListModalLabel">
                        <i class="fas fa-mobile-alt me-2"></i>Device Management
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Drone ID</th>
                                    <th>Status</th>
                                    <th>Position</th>
                                    <th>Mission</th>
                                    <th>Battery</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTableBody">
                                <tr>
                                    <td>Drone 1</td>
                                    <td><span class="badge bg-success">Available</span></td>
                                    <td>21.028, 105.854</td>
                                    <td><span class="text-muted">-</span></td>
                                    <td>85%</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Drone 2</td>
                                    <td><span class="badge bg-warning">Busy</span></td>
                                    <td>21.030, 105.856</td>
                                    <td>Search Mission Alpha</td>
                                    <td>62%</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Drone 3</td>
                                    <td><span class="badge bg-success">Available</span></td>
                                    <td>21.025, 105.850</td>
                                    <td><span class="text-muted">-</span></td>
                                    <td>95%</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">View</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ DROP ITEMS MODAL ============ -->
    <div class="modal fade" id="dropItemsModal" tabindex="-1" aria-labelledby="dropItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dropItemsModalLabel">
                        <i class="fas fa-parachute-box me-2"></i>Drop Items
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dropItemsContent">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Only available for transport drones
                        </div>
                        <div class="mb-3">
                            <label for="dropItemSelect" class="form-label">Select Item to Drop</label>
                            <select class="form-select" id="dropItemSelect">
                                <option value="">Select item...</option>
                                <option value="first-aid">First Aid Kit</option>
                                <option value="life-vest">Life Vest</option>
                                <option value="water">Water Bottle</option>
                                <option value="food">Emergency Food</option>
                                <option value="flashlight">Flashlight</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Drop Location</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" step="0.000001" class="form-control" id="dropLat" placeholder="Latitude">
                                </div>
                                <div class="col-6">
                                    <input type="number" step="0.000001" class="form-control" id="dropLng" placeholder="Longitude">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-info mt-2" id="useCurrentDropLocation">
                                <i class="fas fa-crosshairs me-2"></i>Use Current Position
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDropItems">
                        <i class="fas fa-parachute-box me-2"></i>Drop Item
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ VOICE RECORDING MODAL ============ -->
    <div class="modal fade" id="voiceRecordModal" tabindex="-1" aria-labelledby="voiceRecordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="voiceRecordModalLabel">
                        <i class="fas fa-microphone me-2"></i>Voice Recording
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="voiceRecordStatus">
                        <div class="mb-3">
                            <i class="fas fa-microphone fa-3x text-danger mb-3" id="micIcon"></i>
                        </div>
                        <h5 id="voiceStatusText">Ready to Record</h5>
                        <div id="voiceCountdown" class="display-4 text-primary my-4" style="display: none;">15</div>
                        <div id="voiceWaiting" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Waiting for upload from Pi 3...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeVoiceModal">Close</button>
                    <button type="button" class="btn btn-danger" id="startVoiceRecord">
                        <i class="fas fa-microphone me-2"></i>Start Recording
                    </button>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/webrtc_client.js') }}"></script>
<script src="{{ url_for('static', filename='js/video-layout.js') }}"></script>
<script src="{{ url_for('static', filename='js/gps_client.js') }}"></script>
<script>
    // Initialize Socket.IO and make it global
    window.socket = io();
    
    // Current GPS coordinates
    let currentLat = 21.0285;  // Default: Hanoi
    let currentLng = 105.8542;
    let currentAltitude = 0;
    
    // WebRTC variables (drone is offerer)
    let peerConnection = null;
    let currentDeviceId = 'drone-camera';
    let videoElement = null;
    let isStreamActive = false;
    let wasStreamActive = false; // Track if stream was active before disconnect
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    
    // Video layout state
    let videoLayout = 'single'; // 'single', 'pip', 'split'
    
    // Initialize Map
    const map = L.map('map').setView([currentLat, currentLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
    }).addTo(map);
    
    // Add marker for current drone position
    let marker = L.marker([currentLat, currentLng]).addTo(map);
    marker.bindPopup("<b>Drone Camera</b><br>Waiting for GPS...").openPopup();
    
    // Fix map size after init
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
    
    // ============================================
    // VIDEO ELEMENT MANAGEMENT
    // ============================================
    
    function createVideoElement() {
        const videoGrid = document.getElementById('videoGrid');
        
        // Clear existing videos
        videoGrid.innerHTML = '';
        
        // Create main video element
        const video = document.createElement('video');
        video.id = 'mainVideo';
        video.autoplay = true;
        video.playsinline = true;
        video.muted = true;
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.objectFit = 'contain';
        video.style.background = '#000';
        
        videoGrid.appendChild(video);
        videoElement = video;
        
        console.log('✅ Video element created');
        return video;
    }
    
    function toggleVideoLayout() {
        const layouts = ['single', 'pip', 'split'];
        const currentIndex = layouts.indexOf(videoLayout);
        videoLayout = layouts[(currentIndex + 1) % layouts.length];
        
        console.log('🔄 Switching to layout:', videoLayout);
        addEventLog('info', `Video layout: ${videoLayout}`);
        
        // Apply layout styles
        const videoGrid = document.getElementById('videoGrid');
        switch(videoLayout) {
            case 'single':
                videoGrid.style.display = 'block';
                break;
            case 'pip':
                videoGrid.style.display = 'grid';
                videoGrid.style.gridTemplateColumns = '1fr';
                break;
            case 'split':
                videoGrid.style.display = 'grid';
                videoGrid.style.gridTemplateColumns = '1fr 1fr';
                break;
        }
    }
    
    // Update Active Drone when selector changes
    document.getElementById('droneSelector').addEventListener('change', function(e) {
        const droneId = e.target.value;
        const droneName = e.target.options[e.target.selectedIndex].text;
        document.getElementById('activeDrone').textContent = droneName;
        addEventLog('info', `Switched to ${droneName}`);
        
        // Stop current stream
        stopWebRTCStream();
        
        // Update device ID
        currentDeviceId = droneId;
        
        // Auto-start new stream
        setTimeout(() => {
            startWebRTCStream();
        }, 500);
    });

    // ============================================
    // WEBRTC FUNCTIONS (Drone is Offerer)
    // ============================================
    
    async function createPeerConnection() {
        console.log('🔧 Creating peer connection...');
        
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'turn:relay1.expressturn.com:3480', username: '000000002076929768', credential: 'glxmCqGZVm2WqKrB/EXZsf2SZGc=' }
            ]
        };
        
        peerConnection = new RTCPeerConnection(config);
        
        // Connection state handler
        peerConnection.onconnectionstatechange = () => {
            const state = peerConnection.connectionState;
            console.log('🔄 Connection state:', state);
            
            if (state === 'connected') {
                isStreamActive = true;
                wasStreamActive = true;
                reconnectAttempts = 0;
                addEventLog('success', 'Video stream connected', 'webrtc');
                document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-pause\"></i>';
            } else if (state === 'disconnected') {
                isStreamActive = false;
                addEventLog('warning', 'Video stream disconnected - reconnecting...', 'webrtc');
                // Auto-reconnect after brief delay
                if (wasStreamActive && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        console.log(`🔄 Reconnect attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        startWebRTCStream();
                    }, 2000);
                }
            } else if (state === 'failed') {
                isStreamActive = false;
                addEventLog('error', 'Video stream failed', 'webrtc');
                // Try to reconnect
                if (wasStreamActive && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        console.log(`🔄 Reconnect attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                        peerConnection = null; // Force new connection
                        startWebRTCStream();
                    }, 3000);
                } else {
                    document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-play\"></i>';
                }
            }
        };
        
        // ICE connection state handler
        peerConnection.oniceconnectionstatechange = () => {
            console.log('🧊 ICE connection state:', peerConnection.iceConnectionState);
        };
        
        // ICE candidate handler - send to server
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('webrtc_ice_candidate', {
                    device_id: currentDeviceId,
                    candidate: event.candidate
                });
                console.log('📤 Sent ICE candidate to server');
            }
        };
        
        // Track handler - receive video from drone
        peerConnection.ontrack = (event) => {
            console.log('📹 Received video track from drone');
            
            if (event.streams && event.streams[0]) {
                if (!videoElement) {
                    videoElement = createVideoElement();
                }
                
                videoElement.srcObject = event.streams[0];
                
                // Auto-play
                videoElement.play()
                    .then(() => {
                        console.log('✅ Video playing');
                        addEventLog('success', 'Video stream playing');
                    })
                    .catch(e => {
                        console.warn('⚠️ Auto-play blocked:', e);
                        addEventLog('warning', 'Click play button to start video');
                    });
            }
        };
        
        console.log('✅ Peer connection created');
    }
    
    async function startWebRTCStream() {
        console.log('▶️ Starting WebRTC stream for:', currentDeviceId);
        
        try {
            // Create video element if needed
            if (!videoElement) {
                videoElement = createVideoElement();
            }
            
            // Create peer connection if needed
            if (!peerConnection || peerConnection.connectionState === 'closed') {
                await createPeerConnection();
            }
            
            // Request stream from drone (drone will send offer)
            console.log('📤 Requesting stream from drone:', currentDeviceId);
            socket.emit('start_webrtc', {
                device_id: currentDeviceId
            });
            
            addEventLog('info', 'Requesting video stream...');
            document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i>';
            
        } catch (error) {
            console.error('❌ Error starting WebRTC:', error);
            addEventLog('error', 'Failed to start stream: ' + error.message);
            document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-play\"></i>';
        }
    }
    
    function stopWebRTCStream() {
        console.log('⏸️ Pausing WebRTC stream');
        
        try {
            // Just pause, don't close connection
            if (videoElement) {
                videoElement.pause();
            }
            
            isStreamActive = false;
            addEventLog('info', 'Video stream paused');
            document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-play\"></i>';
            
        } catch (error) {
            console.error('❌ Error pausing WebRTC:', error);
        }
    }
    
    function closeWebRTCStream() {
        console.log('⏹️ Closing WebRTC stream');
        
        try {
            // Send stop signal to server/drone
            socket.emit('stop_webrtc', {
                device_id: currentDeviceId
            });
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Clear video
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            isStreamActive = false;
            wasStreamActive = false;
            reconnectAttempts = 0;
            addEventLog('info', 'Video stream closed');
            document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-play\"></i>';
            
        } catch (error) {
            console.error('❌ Error closing WebRTC:', error);
        }
    }
    
    // ============================================
    // WEBRTC SIGNALING (Socket.IO Handlers)
    // ============================================
    
    // Receive offer from drone
    socket.on('webrtc_offer', async (data) => {
        if (data.device_id !== currentDeviceId) {
            console.log('⏭️ Offer not for current device, ignoring');
            return;
        }
        
        try {
            console.log('📨 Received offer from drone');
            
            // Create peer connection if needed
            if (!peerConnection || peerConnection.connectionState === 'closed') {
                await createPeerConnection();
            }
            
            // Set remote description (the offer from drone)
            const remoteDesc = new RTCSessionDescription({
                sdp: data.sdp,
                type: data.type
            });
            
            await peerConnection.setRemoteDescription(remoteDesc);
            console.log('✅ Set remote description');
            
            // Create and send answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('webrtc_answer', {
                device_id: currentDeviceId,
                sdp: peerConnection.localDescription.sdp,
                type: peerConnection.localDescription.type
            });
            
            console.log('📤 Sent answer to drone');
            
        } catch (error) {
            console.error('❌ Error handling offer:', error);
            addEventLog('error', 'WebRTC negotiation failed');
        }
    });
    
    // Receive ICE candidate from drone
    socket.on('webrtc_ice_candidate', async (data) => {
        if (data.device_id !== currentDeviceId) return;
        
        try {
            if (peerConnection && data.candidate) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                console.log('✅ Added ICE candidate');
            }
        } catch (error) {
            console.error('❌ Error adding ICE candidate:', error);
        }
    });

    // ============================================
    // SOCKET.IO GPS UPDATES
    // ============================================
    
    socket.on('gps_update', (data) => {
        console.log('📍 GPS Update:', data);
        
        // Update current coordinates
        if (data.latitude && data.longitude) {
            currentLat = data.latitude;
            currentLng = data.longitude;
            currentAltitude = data.altitude || 0;
            
            // Update video overlay if exists
            const videoLng = document.getElementById('videoLongitude');
            const videoLat = document.getElementById('videoLatitude');
            if (videoLng) videoLng.textContent = currentLng.toFixed(6);
            if (videoLat) videoLat.textContent = currentLat.toFixed(6);
            
            // Update marker position
            marker.setLatLng([currentLat, currentLng]);
            const deviceName = data.device_name || 'Drone Camera';
            marker.getPopup().setContent(`
                <b>${deviceName}</b><br>
                Lat: ${currentLat.toFixed(6)}<br>
                Lng: ${currentLng.toFixed(6)}<br>
                Alt: ${currentAltitude.toFixed(1)}m
            `);
            
            // Center map on drone if far from view
            const mapCenter = map.getCenter();
            const distance = Math.sqrt(
                Math.pow(mapCenter.lat - currentLat, 2) + 
                Math.pow(mapCenter.lng - currentLng, 2)
            );
            if (distance > 0.01) { // ~1km
                map.panTo([currentLat, currentLng]);
            }
            
            addEventLog('info', `GPS updated: ${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`);
        }
    });
    
    // ============================================
    // DETECTION CHART - Enhanced with zoom & history
    // ============================================
    
    const ctx = document.getElementById('detectionChart').getContext('2d');
    let detectionChartData = {
        labels: [],
        datasets: [{
            label: 'Total People',
            data: [],
            backgroundColor: 'rgba(0, 194, 255, 0.6)',
            borderColor: 'rgba(0, 194, 255, 1)',
            borderWidth: 2,
            fill: true
        }, {
            label: 'Earth People',
            data: [],
            backgroundColor: 'rgba(82, 196, 26, 0.6)',
            borderColor: 'rgba(82, 196, 26, 1)',
            borderWidth: 2,
            fill: true
        }, {
            label: 'Sea People',
            data: [],
            backgroundColor: 'rgba(24, 144, 255, 0.6)',
            borderColor: 'rgba(24, 144, 255, 1)',
            borderWidth: 2,
            fill: true
        }]
    };
    
    const detectionChart = new Chart(ctx, {
        type: 'line',
        data: detectionChartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: 'white',
                        font: { size: 10 },
                        boxWidth: 12
                    }
                },
                title: {
                    display: true,
                    text: new Date().toLocaleDateString('en-GB'),
                    color: 'rgba(255,255,255,0.7)',
                    font: { size: 11 }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return 'Time: ' + context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' people';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'white',
                        font: { size: 10 },
                        stepSize: 5
                    },
                    title: {
                        display: true,
                        text: 'Total People',
                        color: 'rgba(255,255,255,0.8)',
                        font: { size: 11, weight: 'bold' }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'white',
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            onClick: (event, elements) => {
                // Zoom functionality - show detail modal on click
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = detectionChartData.labels[index];
                    const total = detectionChartData.datasets[0].data[index];
                    const earth = detectionChartData.datasets[1].data[index];
                    const sea = detectionChartData.datasets[2].data[index];
                    
                    alert(`Detection at ${label}\n\nTotal: ${total}\nEarth: ${earth}\nSea: ${sea}`);
                }
            }
        }
    });
    
    // Update chart with new detection data
    function updateDetectionChart(data) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        // Calculate cumulative values
        const prevTotal = detectionChartData.datasets[0].data.length > 0 
            ? detectionChartData.datasets[0].data[detectionChartData.datasets[0].data.length - 1] 
            : 0;
        const prevEarth = detectionChartData.datasets[1].data.length > 0 
            ? detectionChartData.datasets[1].data[detectionChartData.datasets[1].data.length - 1] 
            : 0;
        const prevSea = detectionChartData.datasets[2].data.length > 0 
            ? detectionChartData.datasets[2].data[detectionChartData.datasets[2].data.length - 1] 
            : 0;
        
        // Add cumulative data point
        detectionChartData.labels.push(timeLabel);
        detectionChartData.datasets[0].data.push(prevTotal + (data.total || 0));
        detectionChartData.datasets[1].data.push(prevEarth + (data.detections?.earth_person || 0));
        detectionChartData.datasets[2].data.push(prevSea + (data.detections?.sea_person || 0));
        
        // Keep only last 20 data points for visualization
        if (detectionChartData.labels.length > 20) {
            detectionChartData.labels.shift();
            detectionChartData.datasets.forEach(dataset => dataset.data.shift());
        }
        
        // Update chart
        detectionChart.update('none'); // 'none' for no animation
    }
    
    // ============================================
    // HEATMAP - Rescue Locations with pulsing effect
    // ============================================
    
    const heatmapElement = L.map('heatmap').setView([21.0285, 105.8542], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
    }).addTo(heatmapElement);
    
    // Custom pulsing icon style
    const pulsingIconStyle = `
        <style>
            @keyframes pulse-red {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
                }
            }
            .pulse-marker {
                animation: pulse-red 2s infinite;
                border-radius: 50%;
                background: rgba(255, 0, 0, 0.8);
                border: 2px solid rgba(255, 255, 255, 0.9);
            }
        </style>
    `;
    
    // Add rescue locations (example data)
    let rescueLocations = [];
    
    function addRescueLocation(lat, lng, peopleCount) {
        // Determine marker size based on people count
        let size, className;
        if (peopleCount < 5) {
            size = 15; // Small
            className = 'pulse-marker small-marker';
        } else if (peopleCount < 50) {
            size = 25; // Medium
            className = 'pulse-marker medium-marker';
        } else {
            size = 35; // Large
            className = 'pulse-marker large-marker';
        }
        
        const marker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: className,
                html: `<div style="width: ${size}px; height: ${size}px; background: rgba(255,0,0,0.8); border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: ${size/2}px; font-weight: bold; animation: pulse-red 2s infinite;">${peopleCount}</div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            })
        });
        
        marker.bindPopup(`
            <b>Rescue Location</b><br>
            People: ${peopleCount}<br>
            Lat: ${lat.toFixed(6)}<br>
            Lng: ${lng.toFixed(6)}<br>
            <button class="btn btn-sm btn-danger mt-2" onclick="sendRescueMission(${lat}, ${lng}, ${peopleCount})">
                Send Rescue
            </button>
        `);
        
        marker.addTo(heatmapElement);
        rescueLocations.push({ lat, lng, count: peopleCount, marker });
        
        return marker;
    }
    
    window.sendRescueMission = function(lat, lng, count) {
        alert(`Sending rescue mission to:\nLat: ${lat}\nLng: ${lng}\nPeople: ${count}`);
        addEventLog('warning', `Rescue mission sent for ${count} people`);
    };
    
    // Add sample rescue locations
    addRescueLocation(21.030, 105.850, 3);  // Small - < 5 people
    addRescueLocation(21.025, 105.860, 25); // Medium - < 50 people
    addRescueLocation(21.035, 105.845, 120); // Large - 100+ people
    
    // Listen for new rescue locations from detection
    socket.on('rescue_location_detected', (data) => {
        addRescueLocation(data.latitude, data.longitude, data.people_count);
        addEventLog('warning', `New rescue location: ${data.people_count} people at ${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`);
    });
    
    setTimeout(() => {
        heatmapElement.invalidateSize();
    }, 100);
    
    // ============================================
    // VIDEO CONTROL BUTTON HANDLERS
    // ============================================
    
    // Play/Pause Button - Toggle stream without destroying connection
    document.getElementById('playBtn').addEventListener('click', () => {
        console.log('🎬 Play/Pause button clicked');
        
        if (isStreamActive) {
            // Pause stream (keep connection alive)
            if (videoElement) {
                videoElement.pause();
            }
            isStreamActive = false;
            document.getElementById('playBtn').innerHTML = '<i class="fas fa-play"></i>';
            addEventLog('info', 'Video paused');
        } else {
            // Resume or start stream
            if (videoElement && videoElement.srcObject) {
                // Resume existing stream
                videoElement.play();
                isStreamActive = true;
                wasStreamActive = true;
                document.getElementById('playBtn').innerHTML = '<i class="fas fa-pause"></i>';
                addEventLog('info', 'Video resumed');
            } else {
                // Start new stream
                startWebRTCStream();
            }
        }
    });
    
    // Stop Button - Completely close connection
    document.getElementById('stopBtn').addEventListener('click', () => {
        console.log('⏹️ Stop button clicked');
        closeWebRTCStream();
    });
    
    // Layout Toggle Button
    document.getElementById('layoutBtn').addEventListener('click', () => {
        toggleVideoLayout();
    });
    
    // Fullscreen Button
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
        const videoSection = document.querySelector('.video-section');
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            videoSection.requestFullscreen();
        }
    });
    
    // Action Buttons Handlers
    // Add Mission - Uses existing modal
    
    // Drop Items Button
    document.getElementById('dropItemsBtn').addEventListener('click', async function() {
        console.log('📦 Drop Items clicked');
        const droneId = document.getElementById('droneSelector').value;
        
        if (confirm('Are you sure you want to drop items from ' + droneId + '?')) {
            try {
                const response = await fetch('/api/capture/drop-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: droneId,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Visual feedback
                    this.style.background = 'rgba(250,173,20,0.4)';
                    setTimeout(() => {
                        this.style.background = '';
                    }, 500);
                    
                    addEventLog('warning', `Items dropped from ${droneId}`);
                    alert('Items drop command sent successfully!');
                } else {
                    alert('Failed to send drop command: ' + result.message);
                }
            } catch (error) {
                console.error('Error dropping items:', error);
                alert('Error sending drop command. Check console for details.');
            }
        }
    });
    
    // Record Voice Button
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    
    document.getElementById('recordVoiceBtn').addEventListener('click', async function() {
        console.log('🎤 Record Voice clicked');
        const droneId = document.getElementById('droneSelector').value;
        
        if (!isRecording) {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Upload audio to server
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'voice_record.webm');
                    formData.append('device_id', droneId);
                    
                    try {
                        const uploadResponse = await fetch('/api/upload-audio', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const uploadResult = await uploadResponse.json();
                        
                        if (uploadResult.status === 'success') {
                            // Create voice record
                            const recordResponse = await fetch('/api/voice/records', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    device_id: droneId,
                                    audio_url: uploadResult.url,
                                    duration: Math.floor(audioChunks.length / 10) // Estimate
                                })
                            });
                            
                            const recordResult = await recordResponse.json();
                            
                            if (recordResult.status === 'success') {
                                addEventLog('success', 'Voice recording saved and processing', 'voice');
                                loadVoiceRecords();
                            }
                        }
                    } catch (error) {
                        console.error('Error uploading audio:', error);
                        addEventLog('error', 'Failed to save voice recording', 'voice');
                    }
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                
                this.classList.add('recording');
                this.innerHTML = '<i class="fas fa-stop"></i><span>Stop Recording</span>';
                isRecording = true;
                
                addEventLog('info', 'Voice recording started', 'voice');
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Failed to access microphone. Please grant permission.');
            }
        } else {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            this.classList.remove('recording');
            this.innerHTML = '<i class="fas fa-microphone"></i><span>Record Voice</span>';
            isRecording = false;
            
            addEventLog('info', 'Voice recording stopped');
        }
    });
    
    // Device Button - Show device info
    document.getElementById('deviceBtn').addEventListener('click', function() {
        const droneId = document.getElementById('droneSelector').value;
        alert(`Device: ${droneId}\nStatus: Connected\nBattery: 85%\nSignal: Strong`);
        addEventLog('info', 'Device info displayed');
    });
    
    // Add Mission Modal Handlers
    document.getElementById('useCurrentLocation').addEventListener('click', () => {
        // Fill current GPS location
        document.getElementById('missionLatitude').value = currentLat.toFixed(6);
        document.getElementById('missionLongitude').value = currentLng.toFixed(6);
        
        // Show notification
        const btn = document.getElementById('useCurrentLocation');
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Location Set!';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Use Current Drone Location';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-info');
        }, 2000);
    });

    // Set default scheduled time (current time + 1 hour)
    const now = new Date();
    now.setHours(now.getHours() + 1);
    const dateTimeString = now.toISOString().slice(0, 16);
    document.getElementById('scheduledTime').value = dateTimeString;

    // Add Waypoint functionality
    let waypointCounter = 0;
    document.getElementById('addWaypointBtn').addEventListener('click', () => {
        waypointCounter++;
        const waypointsList = document.getElementById('waypointsList');
        const waypointItem = document.createElement('div');
        waypointItem.className = 'waypoint-item';
        waypointItem.innerHTML = `
            <span style="color: white; min-width: 30px;">WP${waypointCounter}</span>
            <input type="number" step="0.000001" class="form-control form-control-sm" placeholder="Latitude" required>
            <input type="number" step="0.000001" class="form-control form-control-sm" placeholder="Longitude" required>
            <input type="number" class="form-control form-control-sm" placeholder="Alt (m)" style="max-width: 100px;" required>
            <button type="button" class="btn btn-sm btn-danger remove-waypoint">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        waypointItem.querySelector('.remove-waypoint').addEventListener('click', () => {
            waypointItem.remove();
        });
        
        waypointsList.appendChild(waypointItem);
    });

    // Create Mission Handler
    document.getElementById('createMissionBtn').addEventListener('click', async () => {
        const form = document.getElementById('newMissionForm');
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Collect waypoints
        const waypoints = [];
        document.querySelectorAll('.waypoint-item').forEach((item, index) => {
            const inputs = item.querySelectorAll('input');
            waypoints.push({
                order: index + 1,
                latitude: parseFloat(inputs[0].value),
                longitude: parseFloat(inputs[1].value),
                altitude: parseFloat(inputs[2].value)
            });
        });
        
        // Prepare mission data
        const missionData = {
            name: document.getElementById('missionName').value,
            type: document.getElementById('missionType').value,
            drone_id: document.getElementById('assignedDrone').value,
            latitude: parseFloat(document.getElementById('missionLatitude').value),
            longitude: parseFloat(document.getElementById('missionLongitude').value),
            altitude: parseFloat(document.getElementById('missionAltitude').value),
            speed: parseFloat(document.getElementById('missionSpeed').value),
            scheduled_time: document.getElementById('scheduledTime').value,
            duration: parseInt(document.getElementById('missionDuration').value),
            priority: document.getElementById('missionPriority').value,
            description: document.getElementById('missionDescription').value,
            waypoints: waypoints,
            created_by: 'ashine92',
            created_at: new Date().toISOString(),
            status: 'scheduled'
        };
        
        console.log('Creating mission:', missionData);
        
        try {
            // Emit to Socket.IO
            socket.emit('create_mission', missionData);
            
            // Also send to backend API if available
            const response = await fetch('/api/missions/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(missionData)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Mission created:', result);
                
                // Add to event logs
                addEventLog('success', `Mission "${missionData.name}" created successfully`);
                
                // Add to task list
                addTaskToList(missionData);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newMissionModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                document.getElementById('waypointsList').innerHTML = '';
                waypointCounter = 0;
                
                // Show success notification
                alert('Mission created successfully!');
            } else {
                throw new Error('Failed to create mission');
            }
        } catch (error) {
            console.error('Error creating mission:', error);
            
            // Still add to local task list and event log
            addEventLog('warning', `Mission "${missionData.name}" created (pending server sync)`);
            addTaskToList(missionData);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newMissionModal'));
            modal.hide();
            
            // Reset form
            form.reset();
            document.getElementById('waypointsList').innerHTML = '';
            waypointCounter = 0;
            
            alert('Mission created locally. Will sync with server when available.');
        }
    });

    // Helper function to add task to Ongoing Task list
    function addTaskToList(missionData) {
        const taskList = document.getElementById('taskList');
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        
        // Calculate progress based on status
        let progress = 0;
        if (missionData.status === 'scheduled') progress = 10;
        else if (missionData.status === 'in_progress') progress = 50;
        else if (missionData.status === 'completed') progress = 100;
        
        // Format time
        const scheduledDate = new Date(missionData.scheduled_time);
        const timeStr = scheduledDate.toLocaleTimeString('en-US', { hour12: false });
        
        taskItem.innerHTML = `
            <div class="task-header">
                <span class="task-title">${missionData.name} - ${missionData.type}</span>
                <span class="task-time">${timeStr}</span>
            </div>
            <div class="task-progress">
                <div class="task-progress-bar" style="width: ${progress}%"></div>
            </div>
        `;
        
        // Add to top of list
        taskList.insertBefore(taskItem, taskList.firstChild);
    }

    // Reset modal when closed
    document.getElementById('newMissionModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('newMissionForm').reset();
        document.getElementById('waypointsList').innerHTML = '';
        waypointCounter = 0;
    });
    
    
    // Load Voice Records from server
    async function loadVoiceRecords() {
        try {
            const response = await fetch('/api/voice/records');
            const data = await response.json();
            
            if (data.status === 'success' && data.records) {
                const voiceRecords = document.getElementById('voiceRecords');
                voiceRecords.innerHTML = ''; // Clear existing
                
                data.records.slice(0, 10).forEach(record => {  // Show latest 10
                    const timeStr = formatTimestamp(record.created_at);
                    
                    const voiceItem = document.createElement('div');
                    voiceItem.className = 'voice-item';
                    voiceItem.innerHTML = `
                        <div class="voice-info">
                            <span class="voice-name">${record.device_id}_${record.id}</span>
                            <span class="voice-time">${timeStr}</span>
                        </div>
                        <button class="download-btn" onclick="window.open('${record.audio_url}', '_blank')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    `;
                    voiceRecords.appendChild(voiceItem);
                });
            }
        } catch (error) {
            console.error('Error loading voice records:', error);
        }
    }
    
    // Load voice records on page load
    loadVoiceRecords();
    
    // Helper function to format timestamps
    function formatTimestamp(timestamp) {
        try {
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return 'Invalid Date';
            }
            return date.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (error) {
            console.error('Error formatting timestamp:', error);
            return 'Error';
        }
    }
    
    // Helper function to add event logs
    function addEventLog(type, message, category = 'general', data = {}) {
        const eventLogs = document.getElementById('eventLogs');
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
        
        // Category icons
        const icons = {
            'mission': 'fa-tasks',
            'waypoint': 'fa-map-marker-alt',
            'detection': 'fa-eye',
            'voice': 'fa-microphone',
            'drone': 'fa-drone',
            'drop': 'fa-parachute-box',
            'webrtc': 'fa-video',
            'gps': 'fa-map-marked-alt',
            'general': 'fa-info-circle'
        };
        
        const eventItem = document.createElement('div');
        eventItem.className = `event-item ${type}`;
        eventItem.setAttribute('data-category', category);
        eventItem.setAttribute('data-timestamp', now.toISOString());
        eventItem.innerHTML = `
            <i class="fas ${icons[category] || icons.general}" style="margin-right: 5px; font-size: 10px;"></i>
            <span class="event-time">[${timeStr}]</span>
            <span class="event-message">${message}</span>
        `;
        
        // Add to top
        eventLogs.insertBefore(eventItem, eventLogs.firstChild);
        
        // Keep only last 100 events (increased from 50)
        while (eventLogs.children.length > 100) {
            eventLogs.removeChild(eventLogs.lastChild);
        }
    }
    
    // Socket.IO Events
    socket.on('connect', () => {
        console.log('✅ Connected to server');
        addEventLog('success', 'Connected to server', 'general');
        
        // Request latest data
        loadVoiceRecords();
        loadMissions(); // Load missions on connect
        
        // Only reconnect WebRTC if it was previously active
        if (isStreamActive || wasStreamActive) {
            console.log('🔄 Reconnecting WebRTC stream...');
            setTimeout(() => {
                startWebRTCStream();
            }, 500);
        }
    });
    
    socket.on('disconnect', () => {
        console.log('❌ Disconnected from server');
        addEventLog('error', 'Disconnected from server');
        
        // Stop stream on disconnect
        isStreamActive = false;
        document.getElementById('playBtn').innerHTML = '<i class=\"fas fa-play\"></i>';
    });
    
    // ============================================
    // CAPTURE BUTTON HANDLER
    // ============================================
    
    document.getElementById('recordBtn').addEventListener('click', async function() {
        console.log('📸 Capture button clicked');
        
        try {
            // Send capture command via Socket.IO
            socket.emit('capture_command', {
                device_id: currentDeviceId,
                timestamp: new Date().toISOString()
            });
            
            addEventLog('info', 'Capture request sent');
            
            // Visual feedback
            this.style.background = 'rgba(255,0,0,0.3)';
            setTimeout(() => {
                this.style.background = '';
            }, 300);
            
        } catch (error) {
            console.error('❌ Capture error:', error);
            addEventLog('error', 'Capture failed');
        }
    });
    
    // Listen for capture result
    socket.on('capture_result', (data) => {
        if (data.success) {
            console.log('✅ Capture success:', data);
            addEventLog('success', `Image captured: ${data.image_url}`);
        } else {
            console.error('❌ Capture error:', data);
            addEventLog('error', 'Capture failed: ' + data.error);
        }
    });
    
    // ============================================
    // WAYPOINT MANAGEMENT
    // ============================================
    
    let waypoints = [];
    let waypointMarkers = [];
    let routeLine = null;
    
    // Add Waypoint Button
    document.getElementById('addWaypointBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('addWaypointModal'));
        modal.show();
    });
    
    // Use Map Center Button
    document.getElementById('useMapCenterBtn').addEventListener('click', () => {
        const center = map.getCenter();
        document.getElementById('waypointLat').value = center.lat.toFixed(6);
        document.getElementById('waypointLng').value = center.lng.toFixed(6);
    });
    
    // Use Current Position Button
    document.getElementById('useCurrentPosBtn').addEventListener('click', () => {
        document.getElementById('waypointLat').value = currentLat.toFixed(6);
        document.getElementById('waypointLng').value = currentLng.toFixed(6);
    });
    
    // Confirm Add Waypoint
    document.getElementById('confirmAddWaypoint').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('waypointLat').value);
        const lng = parseFloat(document.getElementById('waypointLng').value);
        const alt = parseFloat(document.getElementById('waypointAlt').value);
        
        if (isNaN(lat) || isNaN(lng)) {
            alert('Please enter valid coordinates');
            return;
        }
        
        addWaypoint(lat, lng, alt || 50);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('addWaypointModal')).hide();
        
        // Reset form
        document.getElementById('addWaypointForm').reset();
        document.getElementById('waypointAlt').value = 50;
        
        // Force map refresh
        setTimeout(() => map.invalidateSize(), 100);
    });
    
    // Add waypoint to list
    function addWaypoint(lat, lng, alt) {
        const waypoint = {
            id: waypoints.length + 1,
            latitude: lat,
            longitude: lng,
            altitude: alt
        };
        waypoints.push(waypoint);
        
        // Add marker to map
        const marker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: #1890ff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${waypoint.id}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        });
        
        marker.bindPopup(`<b>Waypoint ${waypoint.id}</b><br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}<br>Alt: ${alt}m`);
        marker.addTo(map);
        waypointMarkers.push(marker);
        
        // Update waypoints list
        updateWaypointsList();
        
        // Update route
        updateRoute();
        
        // Force map to update view
        setTimeout(() => {
            map.invalidateSize();
            if (waypoints.length === 1) {
                map.setView([lat, lng], 13);
            }
        }, 100);
        
        addEventLog('success', `Waypoint ${waypoint.id} added at ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'waypoint', waypoint);
    }
    
    // Update waypoints list UI
    function updateWaypointsList() {
        const list = document.getElementById('waypointsList');
        
        if (waypoints.length === 0) {
            list.innerHTML = '<p class="text-muted text-center" style="margin: 10px 0; font-size: 10px;">Click map or Add button</p>';
            return;
        }
        
        let html = '';
        waypoints.forEach((wp, index) => {
            html += `
                <div class="waypoint-item">
                    <div class="waypoint-info">
                        <div class="waypoint-number">${wp.id}</div>
                        <div class="waypoint-coords">
                            ${wp.latitude.toFixed(4)}, ${wp.longitude.toFixed(4)}
                        </div>
                    </div>
                    <div class="waypoint-actions">
                        <button onclick="editWaypoint(${index})"><i class="fas fa-edit"></i></button>
                        <button class="delete" onclick="deleteWaypoint(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }
    
    // Delete waypoint
    window.deleteWaypoint = function(index) {
        if (!confirm('Delete this waypoint?')) return;
        
        // Remove marker
        map.removeLayer(waypointMarkers[index]);
        
        // Remove from arrays
        waypoints.splice(index, 1);
        waypointMarkers.splice(index, 1);
        
        // Renumber waypoints and update markers
        waypoints.forEach((wp, i) => {
            wp.id = i + 1;
        });
        
        // Refresh all markers with new numbers
        waypointMarkers.forEach((marker, i) => {
            map.removeLayer(marker);
        });
        waypointMarkers = [];
        
        waypoints.forEach((wp, i) => {
            const newMarker = L.marker([wp.latitude, wp.longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #1890ff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${wp.id}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            });
            newMarker.bindPopup(`<b>Waypoint ${wp.id}</b><br>Lat: ${wp.latitude.toFixed(6)}<br>Lng: ${wp.longitude.toFixed(6)}<br>Alt: ${wp.altitude}m`);
            newMarker.addTo(map);
            waypointMarkers.push(newMarker);
        });
        
        // Update UI
        updateWaypointsList();
        updateRoute();
        
        addEventLog('warning', `Waypoint deleted and renumbered`, 'waypoint');
    };
    
    // Edit waypoint
    window.editWaypoint = function(index) {
        const wp = waypoints[index];
        document.getElementById('waypointLat').value = wp.latitude;
        document.getElementById('waypointLng').value = wp.longitude;
        document.getElementById('waypointAlt').value = wp.altitude;
        
        // Delete old and add new
        deleteWaypoint(index);
        
        const modal = new bootstrap.Modal(document.getElementById('addWaypointModal'));
        modal.show();
    };
    
    // Update route line
    function updateRoute() {
        // Remove old route
        if (routeLine) {
            map.removeLayer(routeLine);
        }
        
        if (waypoints.length < 2) return;
        
        // Draw route line
        const coords = waypoints.map(wp => [wp.latitude, wp.longitude]);
        routeLine = L.polyline(coords, {
            color: '#1890ff',
            weight: 3,
            opacity: 0.7,
            dashArray: '5, 10'
        });
        routeLine.addTo(map);
    }
    
    // Optimize Route (Auto-routing shortest path)
    document.getElementById('optimizeRouteBtn').addEventListener('click', async () => {
        if (waypoints.length < 2) {
            alert('Add at least 2 waypoints to optimize route');
            return;
        }
        
        try {
            const response = await fetch('/api/optimize-route', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ waypoints: waypoints })
            });
            
            if (!response.ok) {
                throw new Error('Optimization failed');
            }
            
            const data = await response.json();
            
            // Reorder waypoints
            waypoints = data.optimized_waypoints;
            
            // Renumber
            waypoints.forEach((wp, i) => {
                wp.id = i + 1;
            });
            
            // Update markers
            waypointMarkers.forEach(marker => map.removeLayer(marker));
            waypointMarkers = [];
            waypoints.forEach(wp => {
                const marker = L.marker([wp.latitude, wp.longitude], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #1890ff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${wp.id}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                });
                marker.bindPopup(`<b>Waypoint ${wp.id}</b><br>Lat: ${wp.latitude.toFixed(6)}<br>Lng: ${wp.longitude.toFixed(6)}<br>Alt: ${wp.altitude}m`);
                marker.addTo(map);
                waypointMarkers.push(marker);
            });
            
            updateWaypointsList();
            updateRoute();
            
            addEventLog('success', `Route optimized - Distance: ${data.total_distance.toFixed(2)} km`, 'waypoint', data);
        } catch (error) {
            console.error('Route optimization error:', error);
            addEventLog('error', 'Route optimization failed', 'waypoint');
            
            // Fallback: Simple nearest neighbor algorithm
            optimizeRouteLocally();
        }
    });
    
    // Local route optimization (nearest neighbor)
    function optimizeRouteLocally() {
        if (waypoints.length < 2) return;
        
        const optimized = [waypoints[0]];
        const remaining = waypoints.slice(1);
        
        while (remaining.length > 0) {
            const last = optimized[optimized.length - 1];
            let nearest = 0;
            let minDist = Infinity;
            
            remaining.forEach((wp, i) => {
                const dist = Math.sqrt(
                    Math.pow(wp.latitude - last.latitude, 2) + 
                    Math.pow(wp.longitude - last.longitude, 2)
                );
                if (dist < minDist) {
                    minDist = dist;
                    nearest = i;
                }
            });
            
            optimized.push(remaining[nearest]);
            remaining.splice(nearest, 1);
        }
        
        waypoints = optimized;
        waypoints.forEach((wp, i) => {
            wp.id = i + 1;
        });
        
        // Update markers
        waypointMarkers.forEach(marker => map.removeLayer(marker));
        waypointMarkers = [];
        waypoints.forEach(wp => {
            const marker = L.marker([wp.latitude, wp.longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #1890ff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 2px solid white;">${wp.id}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            });
            marker.bindPopup(`<b>Waypoint ${wp.id}</b><br>Lat: ${wp.latitude.toFixed(6)}<br>Lng: ${wp.longitude.toFixed(6)}<br>Alt: ${wp.altitude}m`);
            marker.addTo(map);
            waypointMarkers.push(marker);
        });
        
        updateWaypointsList();
        updateRoute();
        
        addEventLog('success', 'Route optimized locally (nearest neighbor)', 'waypoint');
    }
    
    // Click map to add waypoint
    map.on('click', function(e) {
        if (confirm(`Add waypoint at ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}?`)) {
            addWaypoint(e.latlng.lat, e.latlng.lng, 50);
        }
    });
    
    // ============================================
    // DEVICE BUTTON - Show Device List Modal
    // ============================================
    
    document.getElementById('deviceBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('deviceListModal'));
        modal.show();
        loadDeviceList();
    });
    
    async function loadDeviceList() {
        try {
            const response = await fetch('/api/devices');
            if (!response.ok) throw new Error('Failed to load devices');
            
            const devices = await response.json();
            const tbody = document.getElementById('deviceTableBody');
            
            tbody.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.id}</td>
                    <td><span class="badge bg-${device.status === 'available' ? 'success' : 'warning'}">${device.status}</span></td>
                    <td>${device.latitude.toFixed(4)}, ${device.longitude.toFixed(4)}</td>
                    <td>${device.mission || '<span class="text-muted">-</span>'}</td>
                    <td>${device.battery}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewDevice('${device.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading devices:', error);
        }
    }
    
    window.viewDevice = function(deviceId) {
        alert(`View device: ${deviceId}`);
        // TODO: Switch to device camera/GPS
    };
    
    // ============================================
    // DROP ITEMS BUTTON
    // ============================================
    
    document.getElementById('dropItemsBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('dropItemsModal'));
        modal.show();
    });
    
    document.getElementById('useCurrentDropLocation').addEventListener('click', () => {
        document.getElementById('dropLat').value = currentLat.toFixed(6);
        document.getElementById('dropLng').value = currentLng.toFixed(6);
    });
    
    document.getElementById('confirmDropItems').addEventListener('click', () => {
        const item = document.getElementById('dropItemSelect').value;
        const lat = document.getElementById('dropLat').value;
        const lng = document.getElementById('dropLng').value;
        
        if (!item || !lat || !lng) {
            alert('Please select item and location');
            return;
        }
        
        // Send drop command via Socket.IO
        socket.emit('drop_items', {
            device_id: currentDeviceId,
            item: item,
            latitude: parseFloat(lat),
            longitude: parseFloat(lng),
            timestamp: new Date().toISOString()
        });
        
        addEventLog('warning', `Drop command sent: ${item} at ${lat}, ${lng}`);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('dropItemsModal')).hide();
        
        // Reset form
        document.getElementById('dropItemSelect').value = '';
        document.getElementById('dropLat').value = '';
        document.getElementById('dropLng').value = '';
    });
    
    // ============================================
    // VOICE RECORDING BUTTON
    // ============================================
    
    let voiceRecordingTimer = null;
    
    document.getElementById('recordVoiceBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('voiceRecordModal'));
        modal.show();
    });
    
    document.getElementById('startVoiceRecord').addEventListener('click', function() {
        // Send signal to Raspberry Pi 3
        socket.emit('start_voice_record', {
            device_id: currentDeviceId,
            timestamp: new Date().toISOString()
        });
        
        // Change UI to countdown
        document.getElementById('voiceStatusText').textContent = 'Recording...';
        document.getElementById('micIcon').classList.add('fa-pulse');
        document.getElementById('voiceCountdown').style.display = 'block';
        this.disabled = true;
        
        // Start 15 second countdown
        let countdown = 15;
        document.getElementById('voiceCountdown').textContent = countdown;
        
        voiceRecordingTimer = setInterval(() => {
            countdown--;
            document.getElementById('voiceCountdown').textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(voiceRecordingTimer);
                
                // Show waiting state
                document.getElementById('voiceCountdown').style.display = 'none';
                document.getElementById('voiceWaiting').style.display = 'block';
                document.getElementById('voiceStatusText').textContent = 'Uploading...';
                document.getElementById('micIcon').classList.remove('fa-pulse');
            }
        }, 1000);
        
        addEventLog('info', 'Voice recording started on Pi 3');
    });
    
    // Listen for voice upload completion
    socket.on('voice_upload_complete', (data) => {
        if (voiceRecordingTimer) {
            clearInterval(voiceRecordingTimer);
        }
        
        // Reset UI
        document.getElementById('voiceCountdown').style.display = 'none';
        document.getElementById('voiceWaiting').style.display = 'none';
        document.getElementById('voiceStatusText').textContent = 'Recording Complete!';
        document.getElementById('micIcon').classList.remove('fa-pulse');
        document.getElementById('startVoiceRecord').disabled = false;
        
        addEventLog('success', `Voice record uploaded: ${data.filename}`, 'voice', data);
        
        // Reload voice records
        setTimeout(() => {
            loadVoiceRecords();
            bootstrap.Modal.getInstance(document.getElementById('voiceRecordModal')).hide();
        }, 2000);
    });
    
    // Mission created/updated events
    socket.on('mission_created', (data) => {
        console.log('✅ Mission created:', data);
        addEventLog('success', `Mission "${data.name || data.mission_name}" created`, 'mission', data);
        loadMissions(); // Reload missions
    });
    
    socket.on('mission_updated', (data) => {
        console.log('🔄 Mission updated:', data);
        addEventLog('info', `Mission "${data.name || data.mission_name}" updated`, 'mission', data);
        loadMissions(); // Reload missions
    });
    
    socket.on('mission_status_changed', (data) => {
        console.log('📊 Mission status changed:', data);
        addEventLog('info', `Mission "${data.name}" status: ${data.status}`, 'mission', data);
        loadMissions(); // Reload missions
    });
    
    // Close voice modal reset
    document.getElementById('closeVoiceModal').addEventListener('click', () => {
        if (voiceRecordingTimer) {
            clearInterval(voiceRecordingTimer);
        }
        document.getElementById('voiceCountdown').style.display = 'none';
        document.getElementById('voiceWaiting').style.display = 'none';
        document.getElementById('voiceStatusText').textContent = 'Ready to Record';
        document.getElementById('micIcon').classList.remove('fa-pulse');
        document.getElementById('startVoiceRecord').disabled = false;
    });
    
    // ============================================
    // MISSION CONTROL TABLE
    // ============================================
    
    async function loadMissions() {
        try {
            const response = await fetch('/api/missions');
            if (!response.ok) throw new Error('Failed to load missions');
            
            const missions = await response.json();
            updateMissionControlTable(missions);
            updateOngoingTasks(missions);
        } catch (error) {
            console.error('Error loading missions:', error);
        }
    }
    
    function updateMissionControlTable(missions) {
        const table = document.getElementById('missionControlTable');
        const count = document.getElementById('missionCount');
        
        count.textContent = `${missions.length} Mission${missions.length !== 1 ? 's' : ''}`;
        
        if (missions.length === 0) {
            table.innerHTML = '<p class="text-muted text-center" style="margin: 20px 0; font-size: 11px;">No missions created yet</p>';
            return;
        }
        
        let html = '';
        missions.forEach(mission => {
            // Enhanced status styling with colors
            let statusClass, statusBadge, statusColor;
            switch(mission.status) {
                case 'in_progress':
                case 'active':
                    statusClass = 'active';
                    statusBadge = 'bg-primary';
                    statusColor = '#1890ff';
                    break;
                case 'planned':
                case 'draft':
                    statusClass = 'planned';
                    statusBadge = 'bg-warning';
                    statusColor = '#faad14';
                    break;
                case 'paused':
                    statusClass = 'paused';
                    statusBadge = 'bg-warning';
                    statusColor = '#ff7a00';
                    break;
                case 'completed':
                    statusClass = 'completed';
                    statusBadge = 'bg-success';
                    statusColor = '#52c41a';
                    break;
                default:
                    statusClass = 'unknown';
                    statusBadge = 'bg-secondary';
                    statusColor = '#8c8c8c';
            }
            
            html += `
                <div class="mission-item ${statusClass}" onclick="viewMissionDetail(${mission.id})" style="border-left: 4px solid ${statusColor};">
                    <div class="mission-header">
                        <span class="mission-name">${mission.name}</span>
                        <span class="badge ${statusBadge} mission-status-badge">${mission.status}</span>
                    </div>
                    <div class="mission-details">
                        <span><i class="fas fa-drone"></i> ${mission.device_id || 'Unassigned'}</span>
                        <span><i class="fas fa-route"></i> ${mission.waypoint_count || 0} WP</span>
                        <span><i class="fas fa-ruler"></i> ${(mission.total_distance || 0).toFixed(1)} km</span>
                    </div>
                </div>
            `;
        });
        
        table.innerHTML = html;
    }
    
    window.viewMissionDetail = function(missionId) {
        addEventLog('info', `Viewing mission ${missionId}`);
        // TODO: Show mission detail modal or navigate to mission page
    };
    
    // ============================================
    // ONGOING TASKS
    // ============================================
    
    function updateOngoingTasks(missions) {
        const taskList = document.getElementById('taskList');
        const activeMissions = missions.filter(m => m.status === 'in_progress' || m.status === 'planned');
        
        if (activeMissions.length === 0) {
            taskList.innerHTML = '<p class="text-muted text-center" style="margin: 20px 0; font-size: 10px;">No active tasks</p>';
            return;
        }
        
        let html = '';
        activeMissions.forEach(mission => {
            const progress = mission.waypoints_completed / mission.waypoint_count * 100 || 0;
            const time = new Date(mission.created_at).toLocaleTimeString();
            
            html += `
                <div class="task-item" onclick="viewMissionDetail(${mission.id})">
                    <div class="task-header">
                        <span class="task-title">${mission.name}</span>
                        <span class="task-time">${time}</span>
                    </div>
                    <div class="task-progress">
                        <div class="task-progress-bar" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        });
        
        taskList.innerHTML = html;
    }
    
    // ============================================
    // DETECTION STATS AUTO-UPDATE
    // ============================================
    
    let detectionStats = {
        earth_people: 0,
        sea_people: 0,
        total: 0
    };
    
    let rescueLocationCache = new Map(); // Cache to avoid duplicate markers
    
    // Listen for detection updates from Edge AI (primary event)
    // Unified detection handler function
    function handleDetectionData(data) {
        console.log('🔍 Processing detection data:', data);
        
        // Update GPS if location provided in detection data
        if (data.gps && data.gps.latitude && data.gps.longitude) {
            currentLat = data.gps.latitude;
            currentLng = data.gps.longitude;
            currentAltitude = data.gps.altitude || currentAltitude;
            
            // Update marker position
            marker.setLatLng([currentLat, currentLng]);
            marker.getPopup().setContent(`
                <b>Drone Camera</b><br>
                Lat: ${currentLat.toFixed(6)}<br>
                Lng: ${currentLng.toFixed(6)}<br>
                Alt: ${currentAltitude.toFixed(1)}m
            `);
            
            // Update video overlay if exists
            const videoLng = document.getElementById('videoLongitude');
            const videoLat = document.getElementById('videoLatitude');
            if (videoLng) videoLng.textContent = currentLng.toFixed(6);
            if (videoLat) videoLat.textContent = currentLat.toFixed(6);
        } else if (data.latitude && data.longitude) {
            currentLat = data.latitude;
            currentLng = data.longitude;
            currentAltitude = data.altitude || currentAltitude;
            
            // Update marker position
            marker.setLatLng([currentLat, currentLng]);
            marker.getPopup().setContent(`
                <b>Drone Camera</b><br>
                Lat: ${currentLat.toFixed(6)}<br>
                Lng: ${currentLng.toFixed(6)}<br>
                Alt: ${currentAltitude.toFixed(1)}m
            `);
            
            // Update video overlay if exists
            const videoLng = document.getElementById('videoLongitude');
            const videoLat = document.getElementById('videoLatitude');
            if (videoLng) videoLng.textContent = currentLng.toFixed(6);
            if (videoLat) videoLat.textContent = currentLat.toFixed(6);
        }
        
        // Extract detection counts - support multiple formats
        let earthCount = 0;
        let seaCount = 0;
        let totalCount = 0;
        
        if (data.earth_person_count !== undefined) {
            // Format: earth_person_count, sea_person_count, person_count
            earthCount = data.earth_person_count || 0;
            seaCount = data.sea_person_count || 0;
            totalCount = data.person_count || (earthCount + seaCount);
        } else if (data.detections) {
            // Format: detections.earth_person, detections.sea_person
            if (Array.isArray(data.detections)) {
                // Count from detections array
                data.detections.forEach(det => {
                    if (det.class_name === 'earth_person' || det.class === 'earth_person') earthCount++;
                    if (det.class_name === 'sea_person' || det.class === 'sea_person') seaCount++;
                });
                totalCount = earthCount + seaCount;
            } else {
                earthCount = data.detections.earth_person || 0;
                seaCount = data.detections.sea_person || 0;
                totalCount = earthCount + seaCount;
            }
        }
        
        // Update stats
        detectionStats.earth_people = earthCount;
        detectionStats.sea_people = seaCount;
        detectionStats.total = totalCount;
        
        // Update UI elements
        const statEarth = document.getElementById('statEarth');
        const statSea = document.getElementById('statSea');
        const statTotal = document.getElementById('statTotal');
        
        if (statEarth) statEarth.textContent = detectionStats.earth_people;
        if (statSea) statSea.textContent = detectionStats.sea_people;
        if (statTotal) statTotal.textContent = detectionStats.total;
        
        // Update chart
        updateDetectionChart({
            total: detectionStats.total,
            detections: {
                earth_person: detectionStats.earth_people,
                sea_person: detectionStats.sea_people
            }
        });
        
        // Add event log with GPS info
        if (detectionStats.total > 0) {
            const gpsData = data.gps || data;
            const locationInfo = gpsData.latitude && gpsData.longitude 
                ? ` at ${gpsData.latitude.toFixed(4)}, ${gpsData.longitude.toFixed(4)}`
                : '';
            addEventLog('success', `AI detected: ${detectionStats.total} person(s) - Earth: ${detectionStats.earth_people}, Sea: ${detectionStats.sea_people}${locationInfo}`, 'detection', data);
            
            // Add to heatmap if location provided
            if (gpsData.latitude && gpsData.longitude) {
                const locationKey = `${gpsData.latitude.toFixed(4)}_${gpsData.longitude.toFixed(4)}`;
                
                // Update or create rescue location
                if (rescueLocationCache.has(locationKey)) {
                    // Update existing location
                    const cached = rescueLocationCache.get(locationKey);
                    heatmapElement.removeLayer(cached.marker);
                }
                
                const marker = addRescueLocation(gpsData.latitude, gpsData.longitude, detectionStats.total);
                rescueLocationCache.set(locationKey, { 
                    marker, 
                    count: detectionStats.total,
                    lastUpdate: new Date()
                });
            }
        }
    }
    
    // Listen for detection events
    socket.on('detection_result', handleDetectionData);
    socket.on('detection_update', handleDetectionData);
    
    // ============================================
    // LOAD INITIAL DATA
    // ============================================
    
    // Load missions on page load
    loadMissions();
    
    // Reload missions every 30 seconds
    setInterval(loadMissions, 30000);

</script>
{% endblock %}