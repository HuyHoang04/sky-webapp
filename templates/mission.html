{% extends "layout.html" %}

{% block title %}Mission Management{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/mission-tools.css') }}" />
<style>
    #mission-map {
        height: 600px;
        border-radius: var(--border-radius);
    }
    .mission-sidebar {
        height: calc(600px - 60px);
        overflow-y: auto;
    }
    .waypoint-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .mission-card {
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }
    .mission-card:hover {
        border-left-color: var(--secondary-color);
    }
    .mission-active {
        border-left-color: var(--success-color);
        background: rgba(82, 196, 26, 0.1);
    }
    .mission-completed {
        border-left-color: var(--gray-300);
        opacity: 0.7;
    }
    .mission-planned {
        border-left-color: var(--warning-color);
    }
    .waypoint-item {
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius);
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: move;
        transition: all 0.3s ease;
    }
    .waypoint-item:hover {
        background: rgba(0, 0, 0, 0.3);
    }
    .mission-stats {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--gray-100);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 mt-5">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">Mission Management</h2>
                    <p class="text-muted mb-0">Flight Planning and Mission Control</p>
                </div>
                <div class="d-flex gap-3">
                    <button class="btn btn-outline-light" onclick="clearMission()">
                        <i class="fas fa-eraser me-2"></i>Clear
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMissionModal">
                        <i class="fas fa-plus me-2"></i>New Mission
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mission Map -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-map"></i> Mission Planning</h5>
                        <div class="d-flex align-items-center gap-4 mission-tools">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-light btn-sm" onclick="setDrawingMode('polygon')">
                                    <i class="fas fa-draw-polygon me-2"></i>Area
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="setDrawingMode('marker')">
                                    <i class="fas fa-map-marker-alt me-2"></i>Point
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="setDrawingMode('polyline')">
                                    <i class="fas fa-route me-2"></i>Path
                                </button>
                            </div>
                            <select class="form-select form-select-sm" style="width: 140px;" id="missionType">
                                <option value="survey">Area Survey</option>
                                <option value="inspection">Point Inspection</option>
                                <option value="delivery">Delivery Route</option>
                                <option value="patrol">Patrol Path</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="mission-map"></div>
                    <div class="mission-stats">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-ruler me-2 text-primary"></i>
                                    <div>
                                        <small class="text-muted d-block">Total Distance</small>
                                        <strong id="totalDistance">0.00 km</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock me-2 text-warning"></i>
                                    <div>
                                        <small class="text-muted d-block">Est. Duration</small>
                                        <strong id="estDuration">00:00:00</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-battery-three-quarters me-2 text-success"></i>
                                    <div>
                                        <small class="text-muted d-block">Battery Required</small>
                                        <strong id="batteryRequired">0%</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-camera me-2 text-info"></i>
                                    <div>
                                        <small class="text-muted d-block">Photos Est.</small>
                                        <strong id="photosEst">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mission Control -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5><i class="fas fa-tasks"></i> Mission Control</h5>
                </div>
                <div class="card-body mission-sidebar">
                    <div class="mb-4">
                        <h6 class="mb-3">Active Mission</h6>
                        <div class="mission-card mission-active p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">Area Survey #127</h6>
                                    <small class="text-muted">Started 10 minutes ago</small>
                                </div>
                                <span class="badge bg-success">In Progress</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar bg-success" style="width: 45%"></div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-danger me-2">
                                    <i class="fas fa-stop-circle me-1"></i>Stop
                                </button>
                                <button class="btn btn-sm btn-warning">
                                    <i class="fas fa-pause-circle me-1"></i>Pause
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-3">Waypoints</h6>
                        <div class="waypoint-list" id="waypointList">
                            <div class="waypoint-item">
                                <div class="d-flex justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                        <div>
                                            <div class="mb-1">Waypoint 1</div>
                                            <small class="text-muted">21.0285°N, 105.8542°E</small>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-link text-danger">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h6 class="mb-3">Scheduled Missions</h6>
                        <div class="mission-card mission-planned p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Point Inspection #128</h6>
                                    <small class="text-muted">Scheduled for 14:30</small>
                                </div>
                                <span class="badge bg-warning">Planned</span>
                            </div>
                        </div>
                        <div class="mission-card mission-completed p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Delivery Route #126</h6>
                                    <small class="text-muted">Completed at 09:15</small>
                                </div>
                                <span class="badge bg-secondary">Completed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Configuration -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-cog"></i> Mission Configuration</h5>
                        <button class="btn btn-primary btn-sm" onclick="saveMissionConfig()">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h6 class="mb-3">Flight Parameters</h6>
                            <div class="mb-3">
                                <label class="form-label">Flight Height</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="flightHeight" value="50">
                                    <span class="input-group-text">meters</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Flight Speed</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="flightSpeed" value="5">
                                    <span class="input-group-text">m/s</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Return Home Altitude</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="returnAltitude" value="70">
                                    <span class="input-group-text">meters</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Camera Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">Photo Interval</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="photoInterval" value="2">
                                    <span class="input-group-text">seconds</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Overlap</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="overlap" value="75">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Camera Angle</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cameraAngle" value="90">
                                    <span class="input-group-text">degrees</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shield-alt"></i> Safety Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Minimum Battery for RTH</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="minBattery" value="30">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum Distance</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="maxDistance" value="2000">
                            <span class="input-group-text">meters</span>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="obstacleAvoidance" checked>
                        <label class="form-check-label" for="obstacleAvoidance">
                            Obstacle Avoidance
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="geofencing" checked>
                        <label class="form-check-label" for="geofencing">
                            Geofencing
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="emergencyRTH" checked>
                        <label class="form-check-label" for="emergencyRTH">
                            Emergency Return-to-Home
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Mission Modal -->
<div class="modal fade" id="newMissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Mission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Mission Name</label>
                    <input type="text" class="form-control" id="missionName">
                </div>
                <div class="mb-3">
                    <label class="form-label">Mission Type</label>
                    <select class="form-select" id="newMissionType">
                        <option value="survey">Area Survey</option>
                        <option value="inspection">Point Inspection</option>
                        <option value="delivery">Delivery Route</option>
                        <option value="patrol">Patrol Path</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Schedule Start</label>
                    <input type="datetime-local" class="form-control" id="missionStart">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="missionDescription" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewMission()">Create Mission</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
    // Initialize map
    let missionMap = L.map('mission-map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(missionMap);

    // Initialize drawing controls
    let drawnItems = new L.FeatureGroup();
    missionMap.addLayer(drawnItems);

    let drawControl = new L.Control.Draw({
        draw: {
            polygon: {
                allowIntersection: false,
                showArea: true
            },
            polyline: true,
            circle: false,
            rectangle: false,
            circlemarker: false,
            marker: true
        },
        edit: {
            featureGroup: drawnItems
        }
    });
    missionMap.addControl(drawControl);

    // Handle drawing events
    missionMap.on(L.Draw.Event.CREATED, function(event) {
        let layer = event.layer;
        drawnItems.addLayer(layer);
        updateMissionStats();
    });

    missionMap.on(L.Draw.Event.EDITED, function(event) {
        updateMissionStats();
    });

    missionMap.on(L.Draw.Event.DELETED, function(event) {
        updateMissionStats();
    });

    // Set drawing mode
    function setDrawingMode(mode) {
        // Disable current drawing
        if (drawControl) {
            missionMap.removeControl(drawControl);
        }

        // Configure new drawing control based on mode
        let drawingOptions = {
            polygon: false,
            polyline: false,
            circle: false,
            rectangle: false,
            circlemarker: false,
            marker: false
        };

        drawingOptions[mode] = true;

        drawControl = new L.Control.Draw({
            draw: drawingOptions,
            edit: {
                featureGroup: drawnItems
            }
        });

        missionMap.addControl(drawControl);
    }

    // Update mission statistics
    function updateMissionStats() {
        let totalDistance = 0;
        let estDuration = 0;
        let batteryRequired = 0;
        let photosEst = 0;

        drawnItems.eachLayer(function(layer) {
            if (layer instanceof L.Polyline) {
                totalDistance += layer.getLatLngs().reduce((dist, curr, i, arr) => {
                    if (i === 0) return 0;
                    return dist + curr.distanceTo(arr[i - 1]);
                }, 0);
            }
        });

        // Convert to kilometers
        totalDistance = (totalDistance / 1000).toFixed(2);
        
        // Estimate duration based on flight speed
        let flightSpeed = document.getElementById('flightSpeed').value;
        estDuration = Math.round((totalDistance * 1000) / (flightSpeed));
        
        // Estimate battery usage (rough calculation)
        batteryRequired = Math.min(Math.round((estDuration / 1200) * 100), 100);
        
        // Estimate number of photos
        let photoInterval = document.getElementById('photoInterval').value;
        photosEst = Math.round(estDuration / photoInterval);

        // Update display
        document.getElementById('totalDistance').textContent = `${totalDistance} km`;
        document.getElementById('estDuration').textContent = new Date(estDuration * 1000).toISOString().substr(11, 8);
        document.getElementById('batteryRequired').textContent = `${batteryRequired}%`;
        document.getElementById('photosEst').textContent = photosEst;
    }

    // Clear mission
    function clearMission() {
        drawnItems.clearLayers();
        updateMissionStats();
    }

    // Create new mission
    function createNewMission() {
        const missionData = {
            name: document.getElementById('missionName').value,
            type: document.getElementById('newMissionType').value,
            startTime: document.getElementById('missionStart').value,
            description: document.getElementById('missionDescription').value,
            configuration: {
                flightHeight: document.getElementById('flightHeight').value,
                flightSpeed: document.getElementById('flightSpeed').value,
                returnAltitude: document.getElementById('returnAltitude').value,
                photoInterval: document.getElementById('photoInterval').value,
                overlap: document.getElementById('overlap').value,
                cameraAngle: document.getElementById('cameraAngle').value,
                minBattery: document.getElementById('minBattery').value,
                maxDistance: document.getElementById('maxDistance').value,
                obstacleAvoidance: document.getElementById('obstacleAvoidance').checked,
                geofencing: document.getElementById('geofencing').checked,
                emergencyRTH: document.getElementById('emergencyRTH').checked
            },
            waypoints: []
        };

        // Convert drawn items to waypoints
        drawnItems.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
                missionData.waypoints.push({
                    type: 'point',
                    lat: layer.getLatLng().lat,
                    lng: layer.getLatLng().lng
                });
            } else if (layer instanceof L.Polygon) {
                missionData.waypoints.push({
                    type: 'area',
                    points: layer.getLatLngs()[0].map(latlng => ({
                        lat: latlng.lat,
                        lng: latlng.lng
                    }))
                });
            } else if (layer instanceof L.Polyline) {
                missionData.waypoints.push({
                    type: 'path',
                    points: layer.getLatLngs().map(latlng => ({
                        lat: latlng.lat,
                        lng: latlng.lng
                    }))
                });
            }
        });

        // Send mission data to server
        fetch('/api/missions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(missionData)
        })
        .then(response => response.json())
        .then(data => {
            // Close modal and show success message
            $('#newMissionModal').modal('hide');
            // TODO: Show success toast
            console.log('Mission created:', data);
        })
        .catch(error => {
            console.error('Error creating mission:', error);
            // TODO: Show error toast
        });
    }

    // Save mission configuration
    function saveMissionConfig() {
        const config = {
            flightHeight: document.getElementById('flightHeight').value,
            flightSpeed: document.getElementById('flightSpeed').value,
            returnAltitude: document.getElementById('returnAltitude').value,
            photoInterval: document.getElementById('photoInterval').value,
            overlap: document.getElementById('overlap').value,
            cameraAngle: document.getElementById('cameraAngle').value,
            minBattery: document.getElementById('minBattery').value,
            maxDistance: document.getElementById('maxDistance').value,
            obstacleAvoidance: document.getElementById('obstacleAvoidance').checked,
            geofencing: document.getElementById('geofencing').checked,
            emergencyRTH: document.getElementById('emergencyRTH').checked
        };

        // Save configuration to server
        fetch('/api/mission-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            // TODO: Show success toast
            console.log('Configuration saved:', data);
        })
        .catch(error => {
            console.error('Error saving configuration:', error);
            // TODO: Show error toast
        });
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Update mission stats when flight parameters change
        ['flightSpeed', 'photoInterval'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateMissionStats);
        });
    });
</script>
{% endblock %}