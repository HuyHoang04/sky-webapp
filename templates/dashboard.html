{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 5px;
    }
    .video-container {
        position: relative;
        width: 100%;
        height: 400px;
        background-color: #222;
        border-radius: 5px;
        overflow: hidden;
    }
    .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .device-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    .device-online {
        background-color: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
    }
    .device-offline {
        background-color: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
    }
    .data-card {
        background-color: #2c3034;
        border: 1px solid #495057;
        border-radius: 5px;
    }
    .controls {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Dashboard Gi√°m s√°t</h1>
    
    <div class="row">
        <!-- Video Stream Panel -->
        <div class="col-lg-8 mb-4">
            <div class="card bg-dark text-light border-secondary h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-video me-2"></i>Video Stream</h5>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="videoSourceDropdown" data-bs-toggle="dropdown">
                            Ch·ªçn ngu·ªìn
                        </button>
                        <ul class="dropdown-menu" id="videoSourceList">
                            <li><a class="dropdown-item disabled" href="#">Kh√¥ng c√≥ thi·∫øt b·ªã</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="video-container">
                        <video id="videoStream" autoplay playsinline></video>
                    </div>
                    <div class="controls d-flex justify-content-between mt-3">
                        <div>
                            <button id="startStream" class="btn btn-primary btn-sm">
                                <i class="fas fa-play me-1"></i>B·∫Øt ƒë·∫ßu
                            </button>
                            <button id="stopStream" class="btn btn-danger btn-sm">
                                <i class="fas fa-stop me-1"></i>D·ª´ng
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-success" id="streamStatus">S·∫µn s√†ng</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GPS Map Panel -->
        <div class="col-lg-4 mb-4">
            <div class="card bg-dark text-light border-secondary h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>B·∫£n ƒë·ªì GPS</h5>
                </div>
                <div class="card-body">
                    <div id="map"></div>
                    <div class="mt-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showDrone" checked>
                            <label class="form-check-label" for="showDrone">Hi·ªÉn th·ªã Drone</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showLifebuoy" checked>
                            <label class="form-check-label" for="showLifebuoy">Hi·ªÉn th·ªã Phao c·ª©u h·ªô</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- AI Detection Panel -->
        <div class="col-lg-12 mb-4">
            <div class="card bg-dark text-light border-secondary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Detection - Ph√°t hi·ªán ng∆∞·ªùi</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Auto Report Toggle -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleAutoReport" checked>
                            <label class="form-check-label" for="toggleAutoReport">
                                <small>T·ª± ƒë·ªông ch·ª•p</small>
                            </label>
                        </div>
                        
                        <!-- Interval Selector -->
                        <select id="reportInterval" class="form-select form-select-sm" style="width: auto;">
                            <option value="1">1 ph√∫t</option>
                            <option value="2">2 ph√∫t</option>
                            <option value="3">3 ph√∫t</option>
                            <option value="5">5 ph√∫t</option>
                            <option value="10">10 ph√∫t</option>
                            <option value="15">15 ph√∫t</option>
                            <option value="30">30 ph√∫t</option>
                        </select>
                        
                        <button id="requestReport" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-camera me-1"></i>Ch·ª•p ngay
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Real-time Detection Stats -->
                        <div class="col-lg-4 mb-3">
                            <div id="currentDetection" class="detection-stats-box">
                                <h6 class="text-center mb-3">Ph√°t hi·ªán hi·ªán t·∫°i</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="stat-box earth-stat">
                                            <div class="stat-icon">üèÉ</div>
                                            <div class="stat-label">Earth Person</div>
                                            <div class="stat-value" id="earthPersonCount">0</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-box sea-stat">
                                            <div class="stat-icon">üèä</div>
                                            <div class="stat-label">Sea Person</div>
                                            <div class="stat-value" id="seaPersonCount">0</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-box total-stat">
                                            <div class="stat-icon">üë•</div>
                                            <div class="stat-label">T·ªïng</div>
                                            <div class="stat-value" id="totalPersonCount">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <small class="text-muted" id="lastDetectionTime">Ch∆∞a c√≥ d·ªØ li·ªáu</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detection History -->
                        <div class="col-lg-8">
                            <h6 class="mb-3">B√°o c√°o ƒë√£ l∆∞u</h6>
                            <div id="detectionReportsList" class="report-list" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                                    <p>ƒêang t·∫£i b√°o c√°o...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Device Status Panel -->
        <div class="col-lg-4 mb-4">
            <div class="card bg-dark text-light border-secondary">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>Tr·∫°ng th√°i thi·∫øt b·ªã</h5>
                </div>
                <div class="card-body">
                    <div id="deviceStatusList">
                        <div class="device-status device-online">
                            <h6>Drone 1</h6>
                            <div class="d-flex justify-content-between">
                                <span>Tr·∫°ng th√°i:</span>
                                <span class="text-success">Online</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>K·∫øt n·ªëi:</span>
                                <span>WebRTC</span>
                            </div>
                        </div>
                        <div class="device-status device-offline">
                            <h6>Phao c·ª©u h·ªô 1</h6>
                            <div class="d-flex justify-content-between">
                                <span>Tr·∫°ng th√°i:</span>
                                <span class="text-danger">Offline</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>K·∫øt n·ªëi:</span>
                                <span>WebSocket</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GPS Data Panel -->
        <div class="col-lg-8 mb-4">
            <div class="card bg-dark text-light border-secondary">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-satellite me-2"></i>D·ªØ li·ªáu GPS</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Thi·∫øt b·ªã</th>
                                    <th>Vƒ© ƒë·ªô</th>
                                    <th>Kinh ƒë·ªô</th>
                                    <th>ƒê·ªô cao</th>
                                    <th>T·ªëc ƒë·ªô</th>
                                    <th>C·∫≠p nh·∫≠t l√∫c</th>
                                </tr>
                            </thead>
                            <tbody id="gpsDataTable">
                                <!-- D·ªØ li·ªáu GPS s·∫Ω ƒë∆∞·ª£c load ƒë·ªông -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Kh·ªüi t·∫°o k·∫øt n·ªëi Socket.IO
    const socket = io();
    
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    let map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Markers cho c√°c thi·∫øt b·ªã
    const markers = {};
    
    // Load danh s√°ch video streams t·ª´ API
    async function loadVideoStreams() {
        try {
            const response = await fetch('/api/video/streams');
            const streams = await response.json();
            
            const videoSourceList = document.getElementById('videoSourceList');
            videoSourceList.innerHTML = ''; // Clear existing items
            
            for (const [deviceId, stream] of Object.entries(streams)) {
                const listItem = document.createElement('li');
                const deviceName = stream.device_name || deviceId.charAt(0).toUpperCase() + deviceId.slice(1);
                listItem.innerHTML = `<a class="dropdown-item" href="#" data-device-id="${deviceId}">${deviceName}</a>`;
                videoSourceList.appendChild(listItem);
                
                // Th√™m marker cho b·∫£n ƒë·ªì
                if (!markers[deviceId]) {
                    markers[deviceId] = L.marker([21.0285, 105.8542], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background-color: #007bff; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                            iconSize: [15, 15],
                            iconAnchor: [7, 7]
                        })
                    }).addTo(map).bindPopup(`${deviceName} (${deviceId})`);
                }
            }
            
            // Th√™m event listeners cho c√°c item m·ªõi
            document.querySelectorAll('#videoSourceList a').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const deviceId = this.getAttribute('data-device-id');
                    const deviceName = this.textContent;
                    document.getElementById('videoSourceDropdown').textContent = deviceName;
                    
                    // D·ª´ng stream hi·ªán t·∫°i n·∫øu c√≥
                    if (peerConnection) {
                        peerConnection.close();
                        peerConnection = null;
                        videoElement.srcObject = null;
                    }
                    
                    // B·∫Øt ƒë·∫ßu stream m·ªõi
                    startWebRTC(deviceId);
                });
            });
            
            // Set device ƒë·∫ßu ti√™n l√†m m·∫∑c ƒë·ªãnh
            const firstDevice = document.querySelector('#videoSourceList a[data-device-id]');
            if (firstDevice && !document.getElementById('videoSourceDropdown').getAttribute('data-device-id')) {
                const deviceId = firstDevice.getAttribute('data-device-id');
                const deviceName = firstDevice.textContent;
                document.getElementById('videoSourceDropdown').textContent = deviceName;
                document.getElementById('videoSourceDropdown').setAttribute('data-device-id', deviceId);
            }
            
        } catch (error) {
            console.error('L·ªói khi load danh s√°ch video streams:', error);
        }
    }
    
    // Load danh s√°ch GPS data t·ª´ API
    async function loadGPSData() {
        try {
            const response = await fetch('/api/gps');
            const gpsData = await response.json();
            
            const gpsTable = document.getElementById('gpsDataTable');
            gpsTable.innerHTML = ''; // Clear existing rows
            
            for (const [deviceId, data] of Object.entries(gpsData)) {
                const row = document.createElement('tr');
                const deviceName = data.device_name || deviceId.charAt(0).toUpperCase() + deviceId.slice(1);
                const timestamp = new Date(data.timestamp).toLocaleTimeString();
                
                row.innerHTML = `
                    <td>${deviceName}</td>
                    <td id="${deviceId}-lat">${data.latitude.toFixed(6)}</td>
                    <td id="${deviceId}-lng">${data.longitude.toFixed(6)}</td>
                    <td id="${deviceId}-alt">${data.altitude}m</td>
                    <td id="${deviceId}-speed">${data.speed} km/h</td>
                    <td id="${deviceId}-time">${timestamp}</td>
                `;
                gpsTable.appendChild(row);
                
                // C·∫≠p nh·∫≠t marker tr√™n b·∫£n ƒë·ªì
                if (markers[deviceId]) {
                    markers[deviceId].setLatLng([data.latitude, data.longitude]);
                    markers[deviceId].getPopup().setContent(`${deviceName}<br>ƒê·ªô cao: ${data.altitude}m<br>T·ªëc ƒë·ªô: ${data.speed} km/h`);
                }
            }
        } catch (error) {
            console.error('L·ªói khi load GPS data:', error);
        }
    }
    
    // Load d·ªØ li·ªáu ban ƒë·∫ßu
    loadVideoStreams();
    loadGPSData();
    
    // Initialize Detection Client
    const detectionClient = new window.DetectionClient(socket, function(deviceId, data) {
        // Update current detection display
        document.getElementById('earthPersonCount').textContent = data.earth_person || 0;
        document.getElementById('seaPersonCount').textContent = data.sea_person || 0;
        document.getElementById('totalPersonCount').textContent = data.total || 0;
        document.getElementById('lastDetectionTime').textContent = 
            'C·∫≠p nh·∫≠t l√∫c: ' + new Date(data.timestamp).toLocaleTimeString('vi-VN');
    });
    
    // Load detection reports
    async function loadDetectionReports() {
        const reports = await detectionClient.loadReports(20);
        const reportsList = document.getElementById('detectionReportsList');
        
        if (reports.length === 0) {
            reportsList.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p>Ch∆∞a c√≥ b√°o c√°o n√†o</p>
                </div>
            `;
            return;
        }
        
        reportsList.innerHTML = '';
        reports.forEach(report => {
            const reportItem = detectionClient.createReportItem(report);
            reportsList.appendChild(reportItem);
        });
    }
    
    // Load reports on page load
    loadDetectionReports();
    
    // Refresh reports when new snapshot is saved
    document.addEventListener('detectionSnapshotSaved', function() {
        loadDetectionReports();
    });
    
    // Request on-demand report
    document.getElementById('requestReport').addEventListener('click', function() {
        const deviceId = document.getElementById('videoSourceDropdown').getAttribute('data-device-id') || 'drone-camera';
        detectionClient.requestReport(deviceId);
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang ch·ª•p...';
        
        // Re-enable after 3 seconds
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-camera me-1"></i>Ch·ª•p ngay';
        }, 3000);
    });
    
    // Toggle auto report
    document.getElementById('toggleAutoReport').addEventListener('change', function() {
        const deviceId = document.getElementById('videoSourceDropdown').getAttribute('data-device-id') || 'drone-camera';
        const enabled = this.checked;
        detectionClient.togglePeriodicReport(deviceId, enabled);
    });
    
    // Change report interval
    document.getElementById('reportInterval').addEventListener('change', function() {
        const deviceId = document.getElementById('videoSourceDropdown').getAttribute('data-device-id') || 'drone-camera';
        const intervalMinutes = parseInt(this.value);
        detectionClient.setReportInterval(deviceId, intervalMinutes);
    });
    
    // Listen for config updates
    document.addEventListener('detectionConfigUpdated', function(e) {
        const data = e.detail;
        console.log('Detection config updated:', data);
        
        // Update UI to reflect current state
        if (data.enabled !== undefined) {
            document.getElementById('toggleAutoReport').checked = data.enabled;
        }
        
        if (data.interval !== undefined) {
            const intervalMinutes = Math.floor(data.interval / 60);
            document.getElementById('reportInterval').value = intervalMinutes;
        }
    });
    
    // X·ª≠ l√Ω khi nh·∫≠n d·ªØ li·ªáu GPS m·ªõi
    socket.on('gps_update', function(data) {
        console.log('Nh·∫≠n d·ªØ li·ªáu GPS:', data);
        
        const deviceId = data.device_id;
        const deviceName = data.device_name || deviceId.charAt(0).toUpperCase() + deviceId.slice(1);
        const timestamp = new Date(data.timestamp).toLocaleTimeString();
        
        // Ki·ªÉm tra xem device ƒë√£ c√≥ trong b·∫£ng ch∆∞a
        let row = document.getElementById(`${deviceId}-lat`);
        if (!row) {
            // Th√™m device m·ªõi v√†o b·∫£ng
            const gpsTable = document.getElementById('gpsDataTable');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${deviceName}</td>
                <td id="${deviceId}-lat">${data.latitude.toFixed(6)}</td>
                <td id="${deviceId}-lng">${data.longitude.toFixed(6)}</td>
                <td id="${deviceId}-alt">${data.altitude}m</td>
                <td id="${deviceId}-speed">${data.speed} km/h</td>
                <td id="${deviceId}-time">${timestamp}</td>
            `;
            gpsTable.appendChild(newRow);
            
            // Th√™m marker cho b·∫£n ƒë·ªì n·∫øu ch∆∞a c√≥
            if (!markers[deviceId]) {
                markers[deviceId] = L.marker([data.latitude, data.longitude], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: '<div style="background-color: #007bff; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [15, 15],
                        iconAnchor: [7, 7]
                    })
                }).addTo(map).bindPopup(`${deviceName} (${deviceId})`);
            }
        } else {
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªán c√≥
            document.getElementById(`${deviceId}-lat`).textContent = data.latitude.toFixed(6);
            document.getElementById(`${deviceId}-lng`).textContent = data.longitude.toFixed(6);
            document.getElementById(`${deviceId}-alt`).textContent = `${data.altitude}m`;
            document.getElementById(`${deviceId}-speed`).textContent = `${data.speed} km/h`;
            document.getElementById(`${deviceId}-time`).textContent = timestamp;
        }
        
        // C·∫≠p nh·∫≠t marker tr√™n b·∫£n ƒë·ªì
        if (markers[deviceId]) {
            markers[deviceId].setLatLng([data.latitude, data.longitude]);
            markers[deviceId].getPopup().setContent(`${deviceName}<br>ƒê·ªô cao: ${data.altitude}m<br>T·ªëc ƒë·ªô: ${data.speed} km/h`);
        }
    });
    
    // X·ª≠ l√Ω WebRTC
    const videoElement = document.getElementById('videoStream');
    const startStreamButton = document.getElementById('startStream');
    const stopStreamButton = document.getElementById('stopStream');
    const streamStatus = document.getElementById('streamStatus');
    
    let peerConnection;
    
    // Kh·ªüi t·∫°o k·∫øt n·ªëi WebRTC
    async function startWebRTC(deviceId) {
        try {
            console.log('startWebRTC called with deviceId:', deviceId);
            streamStatus.textContent = 'ƒêang k·∫øt n·ªëi...';
            streamStatus.className = 'badge bg-warning';
            
            // T·∫°o peer connection
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c ICE candidate
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('webrtc_ice_candidate', {
                        device_id: deviceId,
                        candidate: event.candidate
                    });
                }
            };
            
            // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c track
            peerConnection.ontrack = event => {
                console.log('Received video track');
                videoElement.srcObject = event.streams[0];
                streamStatus.textContent = 'ƒêang ph√°t';
                streamStatus.className = 'badge bg-success';
            };
            
            // G·ª≠i y√™u c·∫ßu b·∫Øt ƒë·∫ßu stream ƒë·∫øn server
            console.log('Requesting stream start for device:', deviceId);
            socket.emit('start_webrtc_stream', {
                device_id: deviceId
            });
            
        } catch (error) {
            console.error('L·ªói khi kh·ªüi t·∫°o WebRTC:', error);
            streamStatus.textContent = 'L·ªói k·∫øt n·ªëi';
            streamStatus.className = 'badge bg-danger';
        }
    }
    
    // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c offer t·ª´ server (t·ª´ drone)
    socket.on('webrtc_offer', async function(data) {
        if (!peerConnection) return;
        
        try {
            console.log('Received offer from drone, creating answer');
            const remoteDesc = new RTCSessionDescription({
                sdp: data.sdp,
                type: data.type
            });
            
            await peerConnection.setRemoteDescription(remoteDesc);
            
            // T·∫°o answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // G·ª≠i answer v·ªÅ server
            socket.emit('webrtc_answer', {
                device_id: data.device_id,
                sdp: peerConnection.localDescription.sdp,
                type: peerConnection.localDescription.type
            });
            
            console.log('Sent answer to server');
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω offer:', error);
        }
    });
    
    // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c answer t·ª´ server
    socket.on('webrtc_answer', async function(data) {
        if (!peerConnection) return;
        
        try {
            console.log('Received answer from server, setting remote description');
            const remoteDesc = new RTCSessionDescription({
                type: data.type,
                sdp: data.sdp
            });
            await peerConnection.setRemoteDescription(remoteDesc);
            console.log('Remote description set successfully');
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω answer:', error);
        }
    });
    
    // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c ICE candidate t·ª´ server
    socket.on('webrtc_ice_candidate', async function(data) {
        if (!peerConnection) return;
        
        try {
            await peerConnection.addIceCandidate(data.candidate);
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω ICE candidate:', error);
        }
    });
    
    // S·ª± ki·ªán khi nh·∫•n n√∫t b·∫Øt ƒë·∫ßu stream
    startStreamButton.addEventListener('click', function() {
        const selectedDevice = document.getElementById('videoSourceDropdown').getAttribute('data-device-id') || 'drone-camera';
        console.log('Starting WebRTC for device:', selectedDevice);
        startWebRTC(selectedDevice);
    });
    
    // S·ª± ki·ªán khi nh·∫•n n√∫t d·ª´ng stream
    stopStreamButton.addEventListener('click', function() {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        videoElement.srcObject = null;
        streamStatus.textContent = 'ƒê√£ d·ª´ng';
        streamStatus.className = 'badge bg-secondary';
    });
    
    // X·ª≠ l√Ω khi ch·ªçn ngu·ªìn video
    document.addEventListener('click', function(e) {
        if (e.target.matches('#videoSourceList a')) {
            e.preventDefault();
            const deviceId = e.target.getAttribute('data-device-id');
            const deviceName = e.target.textContent;
            const dropdown = document.getElementById('videoSourceDropdown');
            dropdown.textContent = deviceName;
            dropdown.setAttribute('data-device-id', deviceId);
            
            // D·ª´ng stream hi·ªán t·∫°i n·∫øu c√≥
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
                videoElement.srcObject = null;
            }
            
            // B·∫Øt ƒë·∫ßu stream m·ªõi
            startWebRTC(deviceId);
        }
    });
    
    // X·ª≠ l√Ω khi thi·∫øt b·ªã ƒë∆∞·ª£c th√™m m·ªõi
    socket.on('video_device_added', function(data) {
        console.log('Thi·∫øt b·ªã video m·ªõi:', data);
        
        const deviceId = data.device_id;
        const deviceName = data.device_name || deviceId.charAt(0).toUpperCase() + deviceId.slice(1);
        
        // Th√™m v√†o dropdown video source
        const videoSourceList = document.getElementById('videoSourceList');
        let existingItem = videoSourceList.querySelector(`[data-device-id="${deviceId}"]`);
        
        if (!existingItem) {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<a class="dropdown-item" href="#" data-device-id="${deviceId}">${deviceName}</a>`;
            videoSourceList.appendChild(listItem);
            
            // N·∫øu l√† device ƒë·∫ßu ti√™n, set l√†m m·∫∑c ƒë·ªãnh
            const dropdown = document.getElementById('videoSourceDropdown');
            if (!dropdown.getAttribute('data-device-id')) {
                dropdown.textContent = deviceName;
                dropdown.setAttribute('data-device-id', deviceId);
            }
        }
        
        // Th√™m v√†o b·∫£ng GPS n·∫øu ch∆∞a c√≥
        let gpsRow = document.getElementById(`${deviceId}-lat`);
        if (!gpsRow) {
            const gpsTable = document.getElementById('gpsDataTable');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${deviceName}</td>
                <td id="${deviceId}-lat">--</td>
                <td id="${deviceId}-lng">--</td>
                <td id="${deviceId}-alt">--</td>
                <td id="${deviceId}-speed">--</td>
                <td id="${deviceId}-time">--</td>
            `;
            gpsTable.appendChild(newRow);
        }
        
        // Th√™m marker cho b·∫£n ƒë·ªì n·∫øu ch∆∞a c√≥
        if (!markers[deviceId]) {
            markers[deviceId] = L.marker([21.0285, 105.8542], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #007bff; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                    iconSize: [15, 15],
                    iconAnchor: [7, 7]
                })
            }).addTo(map).bindPopup(`${deviceName} (${deviceId})`);
        }
    });
</script>
{% endblock %}